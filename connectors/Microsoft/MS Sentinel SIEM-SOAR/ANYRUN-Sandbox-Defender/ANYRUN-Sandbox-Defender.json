{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "logicAppName": {
            "type": "string",
            "defaultValue": "ANYRUN-Sandbox-Defender"
        },
        "azureTenantId": {
            "type": "string",
            "metadata": {
                "description": "Azure Tenant ID for authentication."
            }
        },
        "azureClientId": {
            "type": "string",
            "metadata": {
                "description": "Azure Client ID for authentication."
            }
        },
        "azureClientSecret": {
            "type": "securestring",
            "metadata": {
                "description": "Azure Client Secret for authentication."
            }
        },
        "keyVaultName": {
            "type": "string",
            "metadata": {
                "description": "Key Vault name."
            }
        },
        "keyVaultUri": {
            "type": "string",
            "metadata": {
                "description": "Key Vault URI."
            }
        },
        "azureBlobStorageAccountName": {
            "type": "string",
            "metadata": {
                "description": "Azure Blob Storage Account Name."
            }
        },
        "azureBlobStorageContainerName": {
            "type": "string",
            "metadata": {
                "description": "Azure Blob Storage Container Name."
            }
        },
        "logAnalyticsWorkspaceName": {
            "type": "string",
            "metadata": {
                "description": "Log Analytics Workspace Name."
            }
        }
    },
    "variables": {
        "azuresentinelConnectionName": "azuresentinel--anyrun-app",
        "azureblobConnectionName": "azureblob--anyrun-app",
        "keyVaultConnectionName": "keyvault--anyrun-app",
        "azuremonitorlogsConnectionName": "azuremonitorlogs--anyrun-app",
        "wdatpConnectionName": "wdatp--anyrun-app",
        "azuresentinelApiId": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', resourceGroup().location, '/managedApis/azuresentinel')]",
        "azureblobApiId": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', resourceGroup().location, '/managedApis/azureblob')]",
        "keyVaultApiId": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', resourceGroup().location, '/managedApis/keyvault')]",
        "azuremonitorlogsApiId": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', resourceGroup().location, '/managedApis/azuremonitorlogs')]",
        "wdatpApiId": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', resourceGroup().location, '/managedApis/wdatp')]"
    },
    "resources": [
        {
            "type": "Microsoft.Web/connections",
            "apiVersion": "2016-06-01",
            "name": "[variables('azuresentinelConnectionName')]",
            "location": "[resourceGroup().location]",
            "properties": {
                "displayName": "[variables('azuresentinelConnectionName')]",
                "customParameterValues": {},
                "api": {
                    "id": "[variables('azuresentinelApiId')]"
                },
                "parameterValues": {
                    "token:tenantId": "[parameters('azureTenantId')]",
                    "token:clientId": "[parameters('azureClientId')]",
                    "token:clientSecret": "[parameters('azureClientSecret')]",
                    "token:grantType": "client_credentials"
                }
            }
        },
        {
            "type": "Microsoft.Web/connections",
            "apiVersion": "2016-06-01",
            "name": "[variables('azureblobConnectionName')]",
            "location": "[resourceGroup().location]",
            "properties": {
                "api": {
                    "id": "[variables('azureblobApiId')]"
                },
                "displayName": "[variables('azureblobConnectionName')]",
                "parameterValueSet": {
                    "name": "servicePrincipalAuth",
                    "values": {
                        "token:clientId": {
                            "value": "[parameters('azureClientId')]"
                        },
                        "token:clientSecret": {
                            "value": "[parameters('azureClientSecret')]"
                        },
                        "token:TenantId": {
                            "value": "[parameters('azureTenantId')]"
                        }
                    }
                }
            }
        },
        {
            "type": "Microsoft.Web/connections",
            "apiVersion": "2016-06-01",
            "name": "[variables('keyVaultConnectionName')]",
            "location": "[resourceGroup().location]",
            "properties": {
                "displayName": "[variables('keyVaultConnectionName')]",
                "customParameterValues": {},
                "api": {
                    "id": "[variables('keyVaultApiId')]"
                },
                "parameterValues": {
                    "vaultName": "[parameters('keyVaultName')]",
                    "token:tenantId": "[parameters('azureTenantId')]",
                    "token:clientId": "[parameters('azureClientId')]",
                    "token:clientSecret": "[parameters('azureClientSecret')]",
                    "token:grantType": "client_credentials",
                    "token:resourceUri": "[parameters('keyVaultUri')]"
                }
            }
        },
        {
            "type": "Microsoft.Web/connections",
            "apiVersion": "2016-06-01",
            "name": "[variables('azuremonitorlogsConnectionName')]",
            "location": "[resourceGroup().location]",
            "properties": {
                "displayName": "[variables('azuremonitorlogsConnectionName')]",
                "customParameterValues": {},
                "api": {
                    "id": "[variables('azuremonitorlogsApiId')]"
                },
                "parameterValues": {
                    "token:tenantId": "[parameters('azureTenantId')]",
                    "token:clientId": "[parameters('azureClientId')]",
                    "token:clientSecret": "[parameters('azureClientSecret')]",
                    "token:grantType": "client_credentials"
                }
            }
        },
        {
            "type": "Microsoft.Web/connections",
            "apiVersion": "2016-06-01",
            "name": "[variables('wdatpConnectionName')]",
            "location": "[resourceGroup().location]",
            "properties": {
                "displayName": "[variables('wdatpConnectionName')]",
                "customParameterValues": {},
                "api": {
                    "id": "[variables('wdatpApiId')]"
                },
                "parameterValues": {
                    "token:tenantId": "[parameters('azureTenantId')]",
                    "token:clientId": "[parameters('azureClientId')]",
                    "token:clientSecret": "[parameters('azureClientSecret')]",
                    "token:grantType": "client_credentials"
                }
            }
        },
        {
            "type": "Microsoft.Logic/workflows",
            "apiVersion": "2017-07-01",
            "name": "[parameters('logicAppName')]",
            "location": "[resourceGroup().location]",
            "tags": {
                "Resource": "Microsoft Sentinel",
                "PlaybookTrigger": "Incident",
                "Custom": "ANYRUN",
                "PlaybookType": "Enrichment"
            },
            "identity": {
                "type": "SystemAssigned"
            },
            "properties": {
                "state": "Enabled",
                "definition": {
                    "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                    "contentVersion": "1.0.0.0",
                    "parameters": {
                        "Azure Tenant ID": {
                            "defaultValue": "[parameters('azureTenantId')]",
                            "type": "String"
                        },
                        "Azure Client ID": {
                            "defaultValue": "[parameters('azureClientId')]",
                            "type": "String"
                        },
                        "Azure Blob Storage Account Name": {
                            "defaultValue": "[parameters('azureBlobStorageAccountName')]",
                            "type": "String"
                        },
                        "Azure Blob Storage Container Name": {
                            "defaultValue": "[parameters('azureBlobStorageContainerName')]",
                            "type": "String"
                        },
                        "Log Analytics Workspace": {
                            "defaultValue": "[parameters('logAnalyticsWorkspaceName')]",
                            "type": "String"
                        },
                        "$connections": {
                            "defaultValue": {},
                            "type": "Object"
                        }
                    },
                    "triggers": {
                        "Microsoft_Sentinel_incident": {
                            "type": "ApiConnectionWebhook",
                            "inputs": {
                                "host": {
                                    "connection": {
                                        "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                    }
                                },
                                "body": {
                                    "callback_url": "@{listCallbackUrl()}"
                                },
                                "path": "/incident-creation"
                            }
                        }
                    },
                    "actions": {
                        "Entities_-_Get_Hosts": {
                            "runAfter": {
                                "All_Entities": [
                                    "Succeeded"
                                ]
                            },
                            "type": "ApiConnection",
                            "inputs": {
                                "host": {
                                    "connection": {
                                        "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                    }
                                },
                                "method": "post",
                                "body": "@triggerBody()?['object']?['properties']?['relatedEntities']",
                                "path": "/entities/host"
                            }
                        },
                        "All_Entities": {
                            "runAfter": {},
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "Entities",
                                        "type": "array",
                                        "value": "@triggerBody()?['object']?['properties']?['relatedEntities']"
                                    }
                                ]
                            }
                        },
                        "Get_secret_-_ANYRUN": {
                            "runAfter": {
                                "Entities_-_Get_URLs": [
                                    "Succeeded"
                                ]
                            },
                            "type": "ApiConnection",
                            "inputs": {
                                "host": {
                                    "connection": {
                                        "name": "@parameters('$connections')['keyvault']['connectionId']"
                                    }
                                },
                                "method": "get",
                                "path": "/secrets/@{encodeURIComponent('ANYRUN-APIKey')}/value"
                            }
                        },
                        "Filter_array_File": {
                            "runAfter": {
                                "Filter_array_Host": [
                                    "Succeeded"
                                ]
                            },
                            "type": "Query",
                            "inputs": {
                                "from": "@variables('Entities')",
                                "where": "@equals(item()?['kind'],'File')"
                            }
                        },
                        "Parse_JSON_-_File": {
                            "runAfter": {
                                "Filter_array_File": [
                                    "Succeeded"
                                ]
                            },
                            "type": "ParseJson",
                            "inputs": {
                                "content": "@body('Filter_array_File')",
                                "schema": {
                                    "type": "array",
                                    "items": {
                                        "type": "object",
                                        "properties": {
                                            "id": {
                                                "type": "string"
                                            },
                                            "name": {
                                                "type": "string"
                                            },
                                            "type": {
                                                "type": "string"
                                            },
                                            "kind": {
                                                "type": "string"
                                            },
                                            "properties": {
                                                "type": "object",
                                                "properties": {
                                                    "fileName": {
                                                        "type": "string"
                                                    },
                                                    "friendlyName": {
                                                        "type": "string"
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        },
                        "For_each_-_Host": {
                            "foreach": "@body('Filter_array_Host')",
                            "actions": {
                                "For_each_-_Find_file_path_on_the_target_host": {
                                    "foreach": "@outputs('Parse_JSON_-_File')['body']",
                                    "actions": {
                                        "KQL_-_Get_FilePath": {
                                            "type": "ApiConnection",
                                            "inputs": {
                                                "host": {
                                                    "connection": {
                                                        "name": "@parameters('$connections')['azuremonitorlogs']['connectionId']"
                                                    }
                                                },
                                                "method": "post",
                                                "body": "DeviceEvents\n| where ActionType ==\"AntivirusDetection\"\n| where DeviceId == \"@{body('Parse_JSON_-_Each_Host')?['additionalData']?['MdatpDeviceId']}\"\n| where FileName == \"@{items('For_each_-_Find_file_path_on_the_target_host')?['properties']?['fileName']}\" and FileName !endswith \".lnk\"\n| project FolderPath, FileName\n| distinct FolderPath, FileName",
                                                "path": "/queryData",
                                                "queries": {
                                                    "subscriptions": "@{variables('Subscription ID')}",
                                                    "resourcegroups": "@{variables('Resource Group Name')}",
                                                    "resourcetype": "Log Analytics Workspace",
                                                    "resourcename": "@{variables('Log Analytics Workspace Name')}",
                                                    "timerange": "7d"
                                                }
                                            }
                                        },
                                        "Parse_JSON_-_Parse_File_Path": {
                                            "runAfter": {
                                                "KQL_-_Get_FilePath": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "ParseJson",
                                            "inputs": {
                                                "content": "@body('KQL_-_Get_FilePath')?['value']",
                                                "schema": {
                                                    "type": "array",
                                                    "items": {
                                                        "type": "object",
                                                        "properties": {
                                                            "FolderPath": {
                                                                "type": "string"
                                                            },
                                                            "FileName": {
                                                                "type": "string"
                                                            }
                                                        },
                                                        "required": [
                                                            "FolderPath",
                                                            "FileName"
                                                        ]
                                                    }
                                                }
                                            }
                                        },
                                        "For_each_-_Set_Folder_Path": {
                                            "foreach": "@outputs('Parse_JSON_-_Parse_File_Path')['body']",
                                            "actions": {
                                                "Set_variable_-_Folder_Path": {
                                                    "type": "SetVariable",
                                                    "inputs": {
                                                        "name": "Suspicious File - FilePath",
                                                        "value": "@concat(item()['FolderPath'], '\\', item()['FileName'])"
                                                    }
                                                },
                                                "Set_variable_-_File_Name": {
                                                    "runAfter": {
                                                        "Set_variable_-_Folder_Path": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "SetVariable",
                                                    "inputs": {
                                                        "name": "Suspicious File - FileName",
                                                        "value": "@item()['FileName']"
                                                    }
                                                }
                                            },
                                            "runAfter": {
                                                "Parse_JSON_-_Parse_File_Path": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "Foreach"
                                        },
                                        "Condition_-_Check_if_KQL_Result_is_not_empty": {
                                            "actions": {
                                                "Until_-_Wait_Live_Response_Completion": {
                                                    "actions": {
                                                        "Delay_-_Check_Status": {
                                                            "runAfter": {
                                                                "Actions_-_Get_single_machine_action": [
                                                                    "Succeeded"
                                                                ]
                                                            },
                                                            "type": "Wait",
                                                            "inputs": {
                                                                "interval": {
                                                                    "count": 15,
                                                                    "unit": "Second"
                                                                }
                                                            }
                                                        },
                                                        "Actions_-_Get_single_machine_action": {
                                                            "type": "ApiConnection",
                                                            "inputs": {
                                                                "host": {
                                                                    "connection": {
                                                                        "name": "@parameters('$connections')['wdatp']['connectionId']"
                                                                    }
                                                                },
                                                                "method": "get",
                                                                "path": "/api/machineactions/@{encodeURIComponent(body('Actions_-_Run_live_response')?['id'])}"
                                                            }
                                                        }
                                                    },
                                                    "runAfter": {
                                                        "Actions_-_Run_live_response": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "expression": "@equals(body('Actions_-_Get_single_machine_action')?['status'], 'Succeeded')",
                                                    "limit": {
                                                        "count": 60,
                                                        "timeout": "PT1H"
                                                    },
                                                    "type": "Until"
                                                },
                                                "HTTP_-_Download_Response_Body": {
                                                    "runAfter": {
                                                        "Actions_-_Get_live_response_command_result_download_URI": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "Http",
                                                    "inputs": {
                                                        "uri": "@body('Actions_-_Get_live_response_command_result_download_URI')?['value']",
                                                        "method": "GET",
                                                        "headers": {
                                                            "Accept": "text/csv"
                                                        }
                                                    },
                                                    "runtimeConfiguration": {
                                                        "contentTransfer": {
                                                            "transferMode": "Chunked"
                                                        }
                                                    }
                                                },
                                                "Parse_JSON_-_Response_Body": {
                                                    "runAfter": {
                                                        "HTTP_-_Download_Response_Body": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "ParseJson",
                                                    "inputs": {
                                                        "content": "@json(string(body('HTTP_-_Download_Response_Body')))",
                                                        "schema": {
                                                            "type": "object",
                                                            "properties": {
                                                                "$content": {
                                                                    "type": "string"
                                                                }
                                                            }
                                                        }
                                                    }
                                                },
                                                "Parse_JSON_-_Parse_Script_Output": {
                                                    "runAfter": {
                                                        "Parse_JSON_-_Response_Body": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "ParseJson",
                                                    "inputs": {
                                                        "content": "@body('Parse_JSON_-_Response_Body')",
                                                        "schema": {
                                                            "type": "object",
                                                            "properties": {
                                                                "script_name": {
                                                                    "type": "string"
                                                                },
                                                                "exit_code": {
                                                                    "type": "integer"
                                                                },
                                                                "script_output": {
                                                                    "type": "string"
                                                                },
                                                                "script_errors": {
                                                                    "type": "string"
                                                                }
                                                            }
                                                        }
                                                    }
                                                },
                                                "Condition_-_If_File_Does_not_upload_to_Blob_Storage": {
                                                    "actions": {
                                                        "Add_comment_to_incident_(V3)_-_File_Does_not_upload_to_Blob": {
                                                            "type": "ApiConnection",
                                                            "inputs": {
                                                                "host": {
                                                                    "connection": {
                                                                        "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                                                    }
                                                                },
                                                                "method": "post",
                                                                "body": {
                                                                    "incidentArmId": "@triggerBody()?['object']?['id']",
                                                                    "message": "<p class=\"editor-paragraph\"><b><strong class=\"editor-text-bold\">The file was not uploaded to Azure Blob Storage.</strong></b></p><p class=\"editor-paragraph\"><br>Check the status of your Storage Account \"@{variables('Storage Account Name')}\" and Container \"@{variables('Container Name')}\" in Azure Blob Storage.</p>"
                                                                },
                                                                "path": "/Incidents/Comment"
                                                            }
                                                        }
                                                    },
                                                    "runAfter": {
                                                        "Parse_JSON_-_Parse_Script_Output": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "else": {
                                                        "actions": {
                                                            "Set_Array_-_Save_the_Response_in_Array_Format": {
                                                                "type": "SetVariable",
                                                                "inputs": {
                                                                    "name": "Array for Response",
                                                                    "value": "@split(body('Parse_JSON_-_Parse_Script_Output')?['script_output'], '\n')"
                                                                }
                                                            },
                                                            "Compose_-_Format_Array": {
                                                                "runAfter": {
                                                                    "Set_Array_-_Save_the_Response_in_Array_Format": [
                                                                        "Succeeded"
                                                                    ]
                                                                },
                                                                "type": "Compose",
                                                                "inputs": "@variables('Array for Response')"
                                                            },
                                                            "Add_comment_to_incident_-_Analysis_Started": {
                                                                "runAfter": {
                                                                    "Condition_-_Machine_OS_is_Windows": [
                                                                        "Succeeded"
                                                                    ]
                                                                },
                                                                "type": "ApiConnection",
                                                                "inputs": {
                                                                    "host": {
                                                                        "connection": {
                                                                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                                                        }
                                                                    },
                                                                    "method": "post",
                                                                    "body": {
                                                                        "incidentArmId": "@triggerBody()?['object']?['id']",
                                                                        "message": "<p class=\"editor-paragraph\"><b><strong class=\"editor-text-bold\">ANY.RUN Sandbox Analysis Started:</strong></b><br>Analysis of the file (@{items('For_each_-_Find_file_path_on_the_target_host')?['properties']?['fileName']}) has been initiated in ANY.RUN Sandbox.</p><br><p class=\"editor-paragraph\"><b><strong class=\"editor-text-bold\">Link to interactive report:</strong></b> https://app.any.run/tasks/@{variables('UUID')}</p>"
                                                                    },
                                                                    "path": "/Incidents/Comment"
                                                                }
                                                            },
                                                            "Delay_-_Wait_for_File_Analysis": {
                                                                "runAfter": {
                                                                    "Delete_blob_(V2)": [
                                                                        "Succeeded"
                                                                    ]
                                                                },
                                                                "type": "Wait",
                                                                "inputs": {
                                                                    "interval": {
                                                                        "count": 250,
                                                                        "unit": "Second"
                                                                    }
                                                                }
                                                            },
                                                            "Get_blob_content_(V2)": {
                                                                "runAfter": {
                                                                    "Compose_-_Format_Array": [
                                                                        "Succeeded"
                                                                    ]
                                                                },
                                                                "type": "ApiConnection",
                                                                "inputs": {
                                                                    "host": {
                                                                        "connection": {
                                                                            "name": "@parameters('$connections')['azureblob']['connectionId']"
                                                                        }
                                                                    },
                                                                    "method": "get",
                                                                    "path": "/v2/datasets/@{encodeURIComponent(encodeURIComponent(variables('Storage Account Name')))}/files/@{encodeURIComponent(encodeURIComponent('/',variables('Container Name'),'/',variables('Suspicious File - FileName')))}/content",
                                                                    "queries": {
                                                                        "inferContentType": true
                                                                    }
                                                                }
                                                            },
                                                            "Delete_blob_(V2)": {
                                                                "runAfter": {
                                                                    "Add_comment_to_incident_-_Analysis_Started": [
                                                                        "Succeeded"
                                                                    ]
                                                                },
                                                                "type": "ApiConnection",
                                                                "inputs": {
                                                                    "host": {
                                                                        "connection": {
                                                                            "name": "@parameters('$connections')['azureblob']['connectionId']"
                                                                        }
                                                                    },
                                                                    "method": "delete",
                                                                    "headers": {
                                                                        "SkipDeleteIfFileNotFoundOnServer": false
                                                                    },
                                                                    "path": "/v2/datasets/@{encodeURIComponent(encodeURIComponent('AccountNameFromSettings'))}/files/@{encodeURIComponent(encodeURIComponent('/',variables('Container Name'),'/',variables('Suspicious File - FileName')))}"
                                                                }
                                                            },
                                                            "Condition_-_Machine_OS_is_Windows": {
                                                                "actions": {
                                                                    "HTTP_-_Submit_File_to_ANY.RUN_Sandbox_Windows": {
                                                                        "type": "Http",
                                                                        "inputs": {
                                                                            "uri": "https://api.any.run/v1/analysis",
                                                                            "method": "POST",
                                                                            "headers": {
                                                                                "Authorization": "API-Key @{body('Get_secret_-_ANYRUN')?['value']}",
                                                                                "Accept": "application/json"
                                                                            },
                                                                            "body": {
                                                                                "$content-type": "multipart/form-data",
                                                                                "$multipart": [
                                                                                    {
                                                                                        "headers": {
                                                                                            "Content-Disposition": "form-data; name=\"file\"; filename=\"@{variables('Suspicious File - FileName')}\""
                                                                                        },
                                                                                        "body": "@{body('Get_blob_content_(V2)')}"
                                                                                    },
                                                                                    {
                                                                                        "headers": {
                                                                                            "Content-Disposition": "form-data; name=\"env_os\""
                                                                                        },
                                                                                        "body": "windows"
                                                                                    },
                                                                                    {
                                                                                        "headers": {
                                                                                            "Content-Disposition": "form-data; name=\"env_bitness\""
                                                                                        },
                                                                                        "body": "64"
                                                                                    },
                                                                                    {
                                                                                        "headers": {
                                                                                            "Content-Disposition": "form-data; name=\"opt_timeout\""
                                                                                        },
                                                                                        "body": "240"
                                                                                    },
                                                                                    {
                                                                                        "headers": {
                                                                                            "Content-Disposition": "form-data; name=\"opt_automated_interactivity\""
                                                                                        },
                                                                                        "body": "true"
                                                                                    },
                                                                                    {
                                                                                        "headers": {
                                                                                            "Content-Disposition": "form-data; name=\"auto_confirm_uac\""
                                                                                        },
                                                                                        "body": "true"
                                                                                    },
                                                                                    {
                                                                                        "headers": {
                                                                                            "Content-Disposition": "form-data; name=\"env_version\""
                                                                                        },
                                                                                        "body": "10"
                                                                                    },
                                                                                    {
                                                                                        "headers": {
                                                                                            "Content-Disposition": "form-data; name=\"obj_ext_extension\""
                                                                                        },
                                                                                        "body": "false"
                                                                                    },
                                                                                    {
                                                                                        "headers": {
                                                                                            "Content-Disposition": "form-data; name=\"env_type\""
                                                                                        },
                                                                                        "body": "complete"
                                                                                    }
                                                                                ]
                                                                            }
                                                                        },
                                                                        "runtimeConfiguration": {
                                                                            "contentTransfer": {
                                                                                "transferMode": "Chunked"
                                                                            }
                                                                        }
                                                                    },
                                                                    "Parse_JSON_-_Get_TaskId_Windows": {
                                                                        "runAfter": {
                                                                            "HTTP_-_Submit_File_to_ANY.RUN_Sandbox_Windows": [
                                                                                "Succeeded"
                                                                            ]
                                                                        },
                                                                        "type": "ParseJson",
                                                                        "inputs": {
                                                                            "content": "@body('HTTP_-_Submit_File_to_ANY.RUN_Sandbox_Windows')",
                                                                            "schema": {
                                                                                "type": "object",
                                                                                "properties": {
                                                                                    "error": {
                                                                                        "type": "boolean"
                                                                                    },
                                                                                    "data": {
                                                                                        "type": "object",
                                                                                        "properties": {
                                                                                            "taskid": {
                                                                                                "type": "string"
                                                                                            }
                                                                                        }
                                                                                    }
                                                                                }
                                                                            }
                                                                        }
                                                                    },
                                                                    "UUID_-_Save_Task_ID_Windows": {
                                                                        "runAfter": {
                                                                            "Parse_JSON_-_Get_TaskId_Windows": [
                                                                                "Succeeded"
                                                                            ]
                                                                        },
                                                                        "type": "SetVariable",
                                                                        "inputs": {
                                                                            "name": "UUID",
                                                                            "value": "@body('Parse_JSON_-_Get_TaskId_Windows')?['data']?['taskid']"
                                                                        }
                                                                    }
                                                                },
                                                                "runAfter": {
                                                                    "Get_blob_content_(V2)": [
                                                                        "Succeeded"
                                                                    ]
                                                                },
                                                                "else": {
                                                                    "actions": {
                                                                        "Condition_-_Machine_OS_is_Ubuntu": {
                                                                            "actions": {
                                                                                "HTTP_-_Submit_File_to_ANY.RUN_Sandbox_Ubuntu": {
                                                                                    "type": "Http",
                                                                                    "inputs": {
                                                                                        "uri": "https://api.any.run/v1/analysis",
                                                                                        "method": "POST",
                                                                                        "headers": {
                                                                                            "Authorization": "API-Key @{body('Get_secret_-_ANYRUN')?['value']}",
                                                                                            "Accept": "application/json"
                                                                                        },
                                                                                        "body": {
                                                                                            "$content-type": "multipart/form-data",
                                                                                            "$multipart": [
                                                                                                {
                                                                                                    "headers": {
                                                                                                        "Content-Disposition": "form-data; name=\"file\"; filename=\"@{variables('Suspicious File - FileName')}\""
                                                                                                    },
                                                                                                    "body": "@{body('Get_blob_content_(V2)')}"
                                                                                                },
                                                                                                {
                                                                                                    "headers": {
                                                                                                        "Content-Disposition": "form-data; name=\"env_os\""
                                                                                                    },
                                                                                                    "body": "linux"
                                                                                                },
                                                                                                {
                                                                                                    "headers": {
                                                                                                        "Content-Disposition": "form-data; name=\"env_bitness\""
                                                                                                    },
                                                                                                    "body": "64"
                                                                                                },
                                                                                                {
                                                                                                    "headers": {
                                                                                                        "Content-Disposition": "form-data; name=\"opt_timeout\""
                                                                                                    },
                                                                                                    "body": "240"
                                                                                                },
                                                                                                {
                                                                                                    "headers": {
                                                                                                        "Content-Disposition": "form-data; name=\"opt_automated_interactivity\""
                                                                                                    },
                                                                                                    "body": "true"
                                                                                                },
                                                                                                {
                                                                                                    "headers": {
                                                                                                        "Content-Disposition": "form-data; name=\"run_as_root\""
                                                                                                    },
                                                                                                    "body": "true"
                                                                                                },
                                                                                                {
                                                                                                    "headers": {
                                                                                                        "Content-Disposition": "form-data; name=\"env_version\""
                                                                                                    },
                                                                                                    "body": "22.04.2"
                                                                                                },
                                                                                                {
                                                                                                    "headers": {
                                                                                                        "Content-Disposition": "form-data; name=\"obj_ext_extension\""
                                                                                                    },
                                                                                                    "body": "false"
                                                                                                },
                                                                                                {
                                                                                                    "headers": {
                                                                                                        "Content-Disposition": "form-data; name=\"env_type\""
                                                                                                    },
                                                                                                    "body": "complete"
                                                                                                }
                                                                                            ]
                                                                                        }
                                                                                    },
                                                                                    "runtimeConfiguration": {
                                                                                        "contentTransfer": {
                                                                                            "transferMode": "Chunked"
                                                                                        }
                                                                                    }
                                                                                },
                                                                                "Parse_JSON_-_Get_TaskId_Ubuntu": {
                                                                                    "runAfter": {
                                                                                        "HTTP_-_Submit_File_to_ANY.RUN_Sandbox_Ubuntu": [
                                                                                            "Succeeded"
                                                                                        ]
                                                                                    },
                                                                                    "type": "ParseJson",
                                                                                    "inputs": {
                                                                                        "content": "@body('HTTP_-_Submit_File_to_ANY.RUN_Sandbox_Ubuntu')",
                                                                                        "schema": {
                                                                                            "type": "object",
                                                                                            "properties": {
                                                                                                "error": {
                                                                                                    "type": "boolean"
                                                                                                },
                                                                                                "data": {
                                                                                                    "type": "object",
                                                                                                    "properties": {
                                                                                                        "taskid": {
                                                                                                            "type": "string"
                                                                                                        }
                                                                                                    }
                                                                                                }
                                                                                            }
                                                                                        }
                                                                                    }
                                                                                },
                                                                                "UUID_-_Save_Task_ID_Ubuntu": {
                                                                                    "runAfter": {
                                                                                        "Parse_JSON_-_Get_TaskId_Ubuntu": [
                                                                                            "Succeeded"
                                                                                        ]
                                                                                    },
                                                                                    "type": "SetVariable",
                                                                                    "inputs": {
                                                                                        "name": "UUID",
                                                                                        "value": "@body('Parse_JSON_-_Get_TaskId_Ubuntu')?['data']?['taskid']"
                                                                                    }
                                                                                }
                                                                            },
                                                                            "else": {
                                                                                "actions": {
                                                                                    "Condition_-_Machine_OS_is_Debian": {
                                                                                        "actions": {
                                                                                            "HTTP_-_Submit_File_to_ANY.RUN_Sandbox_Debian": {
                                                                                                "type": "Http",
                                                                                                "inputs": {
                                                                                                    "uri": "https://api.any.run/v1/analysis",
                                                                                                    "method": "POST",
                                                                                                    "headers": {
                                                                                                        "Authorization": "API-Key @{body('Get_secret_-_ANYRUN')?['value']}",
                                                                                                        "Accept": "application/json"
                                                                                                    },
                                                                                                    "body": {
                                                                                                        "$content-type": "multipart/form-data",
                                                                                                        "$multipart": [
                                                                                                            {
                                                                                                                "headers": {
                                                                                                                    "Content-Disposition": "form-data; name=\"file\"; filename=\"@{variables('Suspicious File - FileName')}\""
                                                                                                                },
                                                                                                                "body": "@{body('Get_blob_content_(V2)')}"
                                                                                                            },
                                                                                                            {
                                                                                                                "headers": {
                                                                                                                    "Content-Disposition": "form-data; name=\"env_os\""
                                                                                                                },
                                                                                                                "body": "linux"
                                                                                                            },
                                                                                                            {
                                                                                                                "headers": {
                                                                                                                    "Content-Disposition": "form-data; name=\"env_bitness\""
                                                                                                                },
                                                                                                                "body": "64"
                                                                                                            },
                                                                                                            {
                                                                                                                "headers": {
                                                                                                                    "Content-Disposition": "form-data; name=\"opt_timeout\""
                                                                                                                },
                                                                                                                "body": "240"
                                                                                                            },
                                                                                                            {
                                                                                                                "headers": {
                                                                                                                    "Content-Disposition": "form-data; name=\"opt_automated_interactivity\""
                                                                                                                },
                                                                                                                "body": "true"
                                                                                                            },
                                                                                                            {
                                                                                                                "headers": {
                                                                                                                    "Content-Disposition": "form-data; name=\"run_as_root\""
                                                                                                                },
                                                                                                                "body": "true"
                                                                                                            },
                                                                                                            {
                                                                                                                "headers": {
                                                                                                                    "Content-Disposition": "form-data; name=\"env_version\""
                                                                                                                },
                                                                                                                "body": "12.2"
                                                                                                            },
                                                                                                            {
                                                                                                                "headers": {
                                                                                                                    "Content-Disposition": "form-data; name=\"obj_ext_extension\""
                                                                                                                },
                                                                                                                "body": "false"
                                                                                                            },
                                                                                                            {
                                                                                                                "headers": {
                                                                                                                    "Content-Disposition": "form-data; name=\"env_type\""
                                                                                                                },
                                                                                                                "body": "complete"
                                                                                                            }
                                                                                                        ]
                                                                                                    }
                                                                                                },
                                                                                                "runtimeConfiguration": {
                                                                                                    "contentTransfer": {
                                                                                                        "transferMode": "Chunked"
                                                                                                    }
                                                                                                }
                                                                                            },
                                                                                            "Parse_JSON_-_Get_TaskId_Debian": {
                                                                                                "runAfter": {
                                                                                                    "HTTP_-_Submit_File_to_ANY.RUN_Sandbox_Debian": [
                                                                                                        "Succeeded"
                                                                                                    ]
                                                                                                },
                                                                                                "type": "ParseJson",
                                                                                                "inputs": {
                                                                                                    "content": "@body('HTTP_-_Submit_File_to_ANY.RUN_Sandbox_Debian')",
                                                                                                    "schema": {
                                                                                                        "type": "object",
                                                                                                        "properties": {
                                                                                                            "error": {
                                                                                                                "type": "boolean"
                                                                                                            },
                                                                                                            "data": {
                                                                                                                "type": "object",
                                                                                                                "properties": {
                                                                                                                    "taskid": {
                                                                                                                        "type": "string"
                                                                                                                    }
                                                                                                                }
                                                                                                            }
                                                                                                        }
                                                                                                    }
                                                                                                }
                                                                                            },
                                                                                            "UUID_-_Save_Task_ID_Debian": {
                                                                                                "runAfter": {
                                                                                                    "Parse_JSON_-_Get_TaskId_Debian": [
                                                                                                        "Succeeded"
                                                                                                    ]
                                                                                                },
                                                                                                "type": "SetVariable",
                                                                                                "inputs": {
                                                                                                    "name": "UUID",
                                                                                                    "value": "@body('Parse_JSON_-_Get_TaskId_Debian')?['data']?['taskid']"
                                                                                                }
                                                                                            }
                                                                                        },
                                                                                        "else": {
                                                                                            "actions": {
                                                                                                "Add_comment_to_incident_(V3)_-_Unsupported_OS_for_analysis": {
                                                                                                    "type": "ApiConnection",
                                                                                                    "inputs": {
                                                                                                        "host": {
                                                                                                            "connection": {
                                                                                                                "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                                                                                            }
                                                                                                        },
                                                                                                        "method": "post",
                                                                                                        "body": {
                                                                                                            "incidentArmId": "@triggerBody()?['object']?['id']",
                                                                                                            "message": "<p class=\"editor-paragraph\"><b><strong class=\"editor-text-bold\">The OS platform \"</strong></b>@{body('Machines_-_Get_single_machine')?['osPlatform']}<b><strong class=\"editor-text-bold\">\" of the host </strong></b>\"@{body('Machines_-_Get_single_machine')?['computerDnsName']}<b><strong class=\"editor-text-bold\">\" </strong></b><b><strong class=\"editor-text-bold\">is not supported for analysis in ANY.RUN Sandbox.</strong></b></p><br><p class=\"editor-paragraph\">Please try to start analysis manually.</p>"
                                                                                                        },
                                                                                                        "path": "/Incidents/Comment"
                                                                                                    }
                                                                                                }
                                                                                            }
                                                                                        },
                                                                                        "expression": {
                                                                                            "and": [
                                                                                                {
                                                                                                    "contains": [
                                                                                                        "@body('Machines_-_Get_single_machine')?['osPlatform']",
                                                                                                        "Debian"
                                                                                                    ]
                                                                                                }
                                                                                            ]
                                                                                        },
                                                                                        "type": "If"
                                                                                    }
                                                                                }
                                                                            },
                                                                            "expression": {
                                                                                "or": [
                                                                                    {
                                                                                        "contains": [
                                                                                            "@body('Machines_-_Get_single_machine')?['osPlatform']",
                                                                                            "Ubuntu"
                                                                                        ]
                                                                                    },
                                                                                    {
                                                                                        "contains": [
                                                                                            "@body('Machines_-_Get_single_machine')?['osPlatform']",
                                                                                            "Linux"
                                                                                        ]
                                                                                    }
                                                                                ]
                                                                            },
                                                                            "type": "If"
                                                                        }
                                                                    }
                                                                },
                                                                "expression": {
                                                                    "and": [
                                                                        {
                                                                            "contains": [
                                                                                "@body('Machines_-_Get_single_machine')?['osPlatform']",
                                                                                "Windows"
                                                                            ]
                                                                        }
                                                                    ]
                                                                },
                                                                "type": "If"
                                                            },
                                                            "Until_File_Analysis_is_not_completed": {
                                                                "actions": {
                                                                    "Parse_JSON_-_Task_Monitor": {
                                                                        "runAfter": {
                                                                            "HTTP-CheckFile-Result": [
                                                                                "Succeeded"
                                                                            ]
                                                                        },
                                                                        "type": "ParseJson",
                                                                        "inputs": {
                                                                            "content": "@trim(replace(body('HTTP-CheckFile-Result'), 'data:', ''))",
                                                                            "schema": {
                                                                                "type": "object",
                                                                                "properties": {
                                                                                    "task": {
                                                                                        "type": "object",
                                                                                        "properties": {
                                                                                            "scores": {
                                                                                                "type": "object",
                                                                                                "properties": {
                                                                                                    "verdict": {
                                                                                                        "type": "object",
                                                                                                        "properties": {
                                                                                                            "threat_level": {
                                                                                                                "type": "integer"
                                                                                                            },
                                                                                                            "text": {
                                                                                                                "type": "string"
                                                                                                            }
                                                                                                        }
                                                                                                    }
                                                                                                }
                                                                                            }
                                                                                        }
                                                                                    }
                                                                                }
                                                                            }
                                                                        }
                                                                    },
                                                                    "HTTP-CheckFile-Result": {
                                                                        "type": "Http",
                                                                        "inputs": {
                                                                            "uri": "https://api.any.run/v1/analysis/monitor/@{variables('UUID')}",
                                                                            "method": "GET",
                                                                            "headers": {
                                                                                "Authorization": "API-Key @{body('Get_secret_-_ANYRUN')?['value']}",
                                                                                "x-anyrun-connector": "@concat('MS_Sentinel:', variables('Connector Version'))"
                                                                            }
                                                                        },
                                                                        "runtimeConfiguration": {
                                                                            "contentTransfer": {
                                                                                "transferMode": "Chunked"
                                                                            }
                                                                        }
                                                                    },
                                                                    "Delay_-_Time_added_to_Task": {
                                                                        "runAfter": {
                                                                            "Parse_JSON_-_Task_Monitor": [
                                                                                "Succeeded"
                                                                            ]
                                                                        },
                                                                        "type": "Wait",
                                                                        "inputs": {
                                                                            "interval": {
                                                                                "count": 60,
                                                                                "unit": "Second"
                                                                            }
                                                                        }
                                                                    }
                                                                },
                                                                "runAfter": {
                                                                    "Delay_-_Wait_for_File_Analysis": [
                                                                        "Succeeded"
                                                                    ]
                                                                },
                                                                "expression": "@equals(body('Parse_JSON_-_Task_Monitor')?['completed'], true)",
                                                                "limit": {
                                                                    "count": 7,
                                                                    "timeout": "PT10M"
                                                                },
                                                                "type": "Until"
                                                            },
                                                            "Condition_-_Is_File_Malicious": {
                                                                "actions": {
                                                                    "HTTP-Full-JSON-Report": {
                                                                        "type": "Http",
                                                                        "inputs": {
                                                                            "uri": "https://api.any.run/v1/analysis/@{variables('UUID')}",
                                                                            "method": "GET",
                                                                            "headers": {
                                                                                "Authorization": "API-Key @{body('Get_secret_-_ANYRUN')?['value']}",
                                                                                "x-anyrun-connector": "@concat('MS_Sentinel:', variables('Connector Version'))"
                                                                            }
                                                                        },
                                                                        "runtimeConfiguration": {
                                                                            "contentTransfer": {
                                                                                "transferMode": "Chunked"
                                                                            }
                                                                        }
                                                                    },
                                                                    "Parse_JSON_-_ANYRUN_Report": {
                                                                        "runAfter": {
                                                                            "HTTP-Full-JSON-Report": [
                                                                                "Succeeded"
                                                                            ]
                                                                        },
                                                                        "type": "ParseJson",
                                                                        "inputs": {
                                                                            "content": "@body('HTTP-Full-JSON-Report')",
                                                                            "schema": {
                                                                                "type": "object",
                                                                                "properties": {
                                                                                    "error": {
                                                                                        "type": "boolean"
                                                                                    },
                                                                                    "data": {
                                                                                        "type": "object",
                                                                                        "properties": {
                                                                                            "analysis": {
                                                                                                "type": "object",
                                                                                                "properties": {
                                                                                                    "uuid": {
                                                                                                        "type": "string"
                                                                                                    },
                                                                                                    "permanentUrl": {
                                                                                                        "type": "string"
                                                                                                    },
                                                                                                    "reports": {
                                                                                                        "type": "object",
                                                                                                        "properties": {
                                                                                                            "IOC": {
                                                                                                                "type": "string"
                                                                                                            },
                                                                                                            "MISP": {
                                                                                                                "type": "string"
                                                                                                            },
                                                                                                            "HTML": {
                                                                                                                "type": "string"
                                                                                                            },
                                                                                                            "STIX": {
                                                                                                                "type": "string"
                                                                                                            },
                                                                                                            "graph": {
                                                                                                                "type": "string"
                                                                                                            }
                                                                                                        }
                                                                                                    },
                                                                                                    "sandbox": {
                                                                                                        "type": "object",
                                                                                                        "properties": {
                                                                                                            "name": {
                                                                                                                "type": "string"
                                                                                                            },
                                                                                                            "plan": {
                                                                                                                "type": "object",
                                                                                                                "properties": {
                                                                                                                    "name": {
                                                                                                                        "type": "string"
                                                                                                                    }
                                                                                                                }
                                                                                                            }
                                                                                                        }
                                                                                                    },
                                                                                                    "duration": {
                                                                                                        "type": "integer"
                                                                                                    },
                                                                                                    "creation": {
                                                                                                        "type": "integer"
                                                                                                    },
                                                                                                    "creationText": {
                                                                                                        "type": "string"
                                                                                                    },
                                                                                                    "stopExec": {
                                                                                                        "type": "integer"
                                                                                                    },
                                                                                                    "stopExecText": {
                                                                                                        "type": "string"
                                                                                                    },
                                                                                                    "tags": {
                                                                                                        "type": "array",
                                                                                                        "items": {
                                                                                                            "type": "object",
                                                                                                            "properties": {
                                                                                                                "users": {
                                                                                                                    "type": "boolean"
                                                                                                                },
                                                                                                                "tag": {
                                                                                                                    "type": "string"
                                                                                                                }
                                                                                                            },
                                                                                                            "required": [
                                                                                                                "users",
                                                                                                                "tag"
                                                                                                            ]
                                                                                                        }
                                                                                                    },
                                                                                                    "options": {
                                                                                                        "type": "object",
                                                                                                        "properties": {
                                                                                                            "timeout": {
                                                                                                                "type": "integer"
                                                                                                            },
                                                                                                            "additionalTime": {
                                                                                                                "type": "integer"
                                                                                                            },
                                                                                                            "fakeNet": {
                                                                                                                "type": "boolean"
                                                                                                            },
                                                                                                            "heavyEvasion": {
                                                                                                                "type": "boolean"
                                                                                                            },
                                                                                                            "mitm": {
                                                                                                                "type": "boolean"
                                                                                                            },
                                                                                                            "tor": {
                                                                                                                "type": "object",
                                                                                                                "properties": {
                                                                                                                    "used": {
                                                                                                                        "type": "boolean"
                                                                                                                    }
                                                                                                                }
                                                                                                            },
                                                                                                            "presentation": {
                                                                                                                "type": "boolean"
                                                                                                            },
                                                                                                            "video": {
                                                                                                                "type": "boolean"
                                                                                                            },
                                                                                                            "hideSource": {
                                                                                                                "type": "boolean"
                                                                                                            },
                                                                                                            "network": {
                                                                                                                "type": "boolean"
                                                                                                            },
                                                                                                            "privacy": {
                                                                                                                "type": "string"
                                                                                                            },
                                                                                                            "privateSample": {
                                                                                                                "type": "boolean"
                                                                                                            },
                                                                                                            "automatization": {
                                                                                                                "type": "object",
                                                                                                                "properties": {
                                                                                                                    "uac": {
                                                                                                                        "type": "boolean"
                                                                                                                    },
                                                                                                                    "interactivity": {
                                                                                                                        "type": "boolean"
                                                                                                                    }
                                                                                                                }
                                                                                                            }
                                                                                                        }
                                                                                                    },
                                                                                                    "scores": {
                                                                                                        "type": "object",
                                                                                                        "properties": {
                                                                                                            "verdict": {
                                                                                                                "type": "object",
                                                                                                                "properties": {
                                                                                                                    "score": {
                                                                                                                        "type": "integer"
                                                                                                                    },
                                                                                                                    "threatLevel": {
                                                                                                                        "type": "integer"
                                                                                                                    },
                                                                                                                    "threatLevelText": {
                                                                                                                        "type": "string"
                                                                                                                    }
                                                                                                                }
                                                                                                            },
                                                                                                            "specs": {
                                                                                                                "type": "object",
                                                                                                                "properties": {
                                                                                                                    "autoStart": {
                                                                                                                        "type": "boolean"
                                                                                                                    },
                                                                                                                    "debugOutput": {
                                                                                                                        "type": "boolean"
                                                                                                                    },
                                                                                                                    "executableDropped": {
                                                                                                                        "type": "boolean"
                                                                                                                    },
                                                                                                                    "multiprocessing": {
                                                                                                                        "type": "boolean"
                                                                                                                    },
                                                                                                                    "serviceLauncher": {
                                                                                                                        "type": "boolean"
                                                                                                                    },
                                                                                                                    "stealing": {
                                                                                                                        "type": "boolean"
                                                                                                                    },
                                                                                                                    "privEscalation": {
                                                                                                                        "type": "boolean"
                                                                                                                    }
                                                                                                                }
                                                                                                            }
                                                                                                        }
                                                                                                    },
                                                                                                    "content": {
                                                                                                        "type": "object",
                                                                                                        "properties": {
                                                                                                            "mainObject": {
                                                                                                                "type": "object",
                                                                                                                "properties": {
                                                                                                                    "type": {
                                                                                                                        "type": "string"
                                                                                                                    },
                                                                                                                    "permanentUrl": {
                                                                                                                        "type": "string"
                                                                                                                    },
                                                                                                                    "filename": {
                                                                                                                        "type": "string"
                                                                                                                    },
                                                                                                                    "basename": {
                                                                                                                        "type": "string"
                                                                                                                    },
                                                                                                                    "info": {
                                                                                                                        "type": "object",
                                                                                                                        "properties": {
                                                                                                                            "ext": {
                                                                                                                                "type": "string"
                                                                                                                            },
                                                                                                                            "file": {
                                                                                                                                "type": "string"
                                                                                                                            },
                                                                                                                            "mime": {
                                                                                                                                "type": "string"
                                                                                                                            },
                                                                                                                            "trid": {
                                                                                                                                "type": "array",
                                                                                                                                "items": {
                                                                                                                                    "type": "object",
                                                                                                                                    "properties": {
                                                                                                                                        "procent": {
                                                                                                                                            "type": "integer"
                                                                                                                                        },
                                                                                                                                        "extension": {
                                                                                                                                            "type": "string"
                                                                                                                                        },
                                                                                                                                        "filetype": {
                                                                                                                                            "type": "string"
                                                                                                                                        }
                                                                                                                                    },
                                                                                                                                    "required": [
                                                                                                                                        "procent",
                                                                                                                                        "extension",
                                                                                                                                        "filetype"
                                                                                                                                    ]
                                                                                                                                }
                                                                                                                            }
                                                                                                                        }
                                                                                                                    },
                                                                                                                    "hashes": {
                                                                                                                        "type": "object",
                                                                                                                        "properties": {
                                                                                                                            "md5": {
                                                                                                                                "type": "string"
                                                                                                                            },
                                                                                                                            "sha1": {
                                                                                                                                "type": "string"
                                                                                                                            },
                                                                                                                            "sha256": {
                                                                                                                                "type": "string"
                                                                                                                            },
                                                                                                                            "ssdeep": {
                                                                                                                                "type": "string"
                                                                                                                            }
                                                                                                                        }
                                                                                                                    }
                                                                                                                }
                                                                                                            },
                                                                                                            "video": {
                                                                                                                "type": "object",
                                                                                                                "properties": {
                                                                                                                    "present": {
                                                                                                                        "type": "boolean"
                                                                                                                    },
                                                                                                                    "permanentUrl": {
                                                                                                                        "type": "string"
                                                                                                                    }
                                                                                                                }
                                                                                                            },
                                                                                                            "pcap": {
                                                                                                                "type": "object",
                                                                                                                "properties": {
                                                                                                                    "present": {
                                                                                                                        "type": "boolean"
                                                                                                                    },
                                                                                                                    "permanentUrl": {
                                                                                                                        "type": "string"
                                                                                                                    }
                                                                                                                }
                                                                                                            },
                                                                                                            "sslkeys": {
                                                                                                                "type": "object",
                                                                                                                "properties": {
                                                                                                                    "present": {
                                                                                                                        "type": "boolean"
                                                                                                                    }
                                                                                                                }
                                                                                                            },
                                                                                                            "screenshots": {
                                                                                                                "type": "array",
                                                                                                                "items": {
                                                                                                                    "type": "object",
                                                                                                                    "properties": {
                                                                                                                        "uuid": {
                                                                                                                            "type": "string"
                                                                                                                        },
                                                                                                                        "time": {
                                                                                                                            "type": "integer"
                                                                                                                        },
                                                                                                                        "permanentUrl": {
                                                                                                                            "type": "string"
                                                                                                                        },
                                                                                                                        "thumbnailUrl": {
                                                                                                                            "type": "string"
                                                                                                                        }
                                                                                                                    },
                                                                                                                    "required": [
                                                                                                                        "uuid",
                                                                                                                        "time",
                                                                                                                        "permanentUrl",
                                                                                                                        "thumbnailUrl"
                                                                                                                    ]
                                                                                                                }
                                                                                                            },
                                                                                                            "dumps": {
                                                                                                                "type": "array",
                                                                                                                "items": {
                                                                                                                    "type": "object",
                                                                                                                    "properties": {
                                                                                                                        "address": {
                                                                                                                            "type": "string"
                                                                                                                        },
                                                                                                                        "size": {
                                                                                                                            "type": "integer"
                                                                                                                        },
                                                                                                                        "pid": {
                                                                                                                            "type": "integer"
                                                                                                                        },
                                                                                                                        "processName": {
                                                                                                                            "type": "string"
                                                                                                                        },
                                                                                                                        "timestamp": {
                                                                                                                            "type": "integer"
                                                                                                                        },
                                                                                                                        "permanentUrl": {
                                                                                                                            "type": "string"
                                                                                                                        },
                                                                                                                        "fileNumber": {
                                                                                                                            "type": "integer"
                                                                                                                        },
                                                                                                                        "taskUUID": {
                                                                                                                            "type": "string"
                                                                                                                        }
                                                                                                                    },
                                                                                                                    "required": [
                                                                                                                        "address",
                                                                                                                        "size",
                                                                                                                        "pid",
                                                                                                                        "processName",
                                                                                                                        "timestamp",
                                                                                                                        "permanentUrl",
                                                                                                                        "fileNumber",
                                                                                                                        "taskUUID"
                                                                                                                    ]
                                                                                                                }
                                                                                                            }
                                                                                                        }
                                                                                                    }
                                                                                                }
                                                                                            },
                                                                                            "environments": {
                                                                                                "type": "object",
                                                                                                "properties": {
                                                                                                    "os": {
                                                                                                        "type": "object",
                                                                                                        "properties": {
                                                                                                            "title": {
                                                                                                                "type": "string"
                                                                                                            },
                                                                                                            "build": {
                                                                                                                "type": "integer"
                                                                                                            },
                                                                                                            "product": {
                                                                                                                "type": "string"
                                                                                                            },
                                                                                                            "variant": {
                                                                                                                "type": "string"
                                                                                                            },
                                                                                                            "productType": {
                                                                                                                "type": "string"
                                                                                                            },
                                                                                                            "major": {
                                                                                                                "type": "string"
                                                                                                            },
                                                                                                            "servicePack": {},
                                                                                                            "softSet": {
                                                                                                                "type": "string"
                                                                                                            },
                                                                                                            "bitness": {
                                                                                                                "type": "integer"
                                                                                                            }
                                                                                                        }
                                                                                                    },
                                                                                                    "internetExplorer": {
                                                                                                        "type": "object",
                                                                                                        "properties": {
                                                                                                            "version": {
                                                                                                                "type": "string"
                                                                                                            },
                                                                                                            "kbnum": {
                                                                                                                "type": "string"
                                                                                                            }
                                                                                                        }
                                                                                                    },
                                                                                                    "software": {
                                                                                                        "type": "array",
                                                                                                        "items": {
                                                                                                            "type": "object",
                                                                                                            "properties": {
                                                                                                                "title": {
                                                                                                                    "type": "string"
                                                                                                                },
                                                                                                                "version": {
                                                                                                                    "type": "string"
                                                                                                                }
                                                                                                            },
                                                                                                            "required": [
                                                                                                                "title",
                                                                                                                "version"
                                                                                                            ]
                                                                                                        }
                                                                                                    },
                                                                                                    "hotfixes": {
                                                                                                        "type": "array",
                                                                                                        "items": {
                                                                                                            "type": "object",
                                                                                                            "properties": {
                                                                                                                "title": {
                                                                                                                    "type": "string"
                                                                                                                }
                                                                                                            },
                                                                                                            "required": [
                                                                                                                "title"
                                                                                                            ]
                                                                                                        }
                                                                                                    }
                                                                                                }
                                                                                            },
                                                                                            "counters": {
                                                                                                "type": "object",
                                                                                                "properties": {
                                                                                                    "processes": {
                                                                                                        "type": "object",
                                                                                                        "properties": {
                                                                                                            "total": {
                                                                                                                "type": "integer"
                                                                                                            },
                                                                                                            "monitored": {
                                                                                                                "type": "integer"
                                                                                                            },
                                                                                                            "suspicious": {
                                                                                                                "type": "integer"
                                                                                                            },
                                                                                                            "malicious": {
                                                                                                                "type": "integer"
                                                                                                            }
                                                                                                        }
                                                                                                    },
                                                                                                    "network": {
                                                                                                        "type": "object",
                                                                                                        "properties": {
                                                                                                            "http": {
                                                                                                                "type": "integer"
                                                                                                            },
                                                                                                            "connections": {
                                                                                                                "type": "integer"
                                                                                                            },
                                                                                                            "dns": {
                                                                                                                "type": "integer"
                                                                                                            },
                                                                                                            "threats": {
                                                                                                                "type": "integer"
                                                                                                            }
                                                                                                        }
                                                                                                    },
                                                                                                    "files": {
                                                                                                        "type": "object",
                                                                                                        "properties": {
                                                                                                            "unknown": {
                                                                                                                "type": "integer"
                                                                                                            },
                                                                                                            "text": {
                                                                                                                "type": "integer"
                                                                                                            },
                                                                                                            "suspicious": {
                                                                                                                "type": "integer"
                                                                                                            },
                                                                                                            "malicious": {
                                                                                                                "type": "integer"
                                                                                                            }
                                                                                                        }
                                                                                                    },
                                                                                                    "registry": {
                                                                                                        "type": "object",
                                                                                                        "properties": {
                                                                                                            "total": {
                                                                                                                "type": "integer"
                                                                                                            },
                                                                                                            "read": {
                                                                                                                "type": "integer"
                                                                                                            },
                                                                                                            "write": {
                                                                                                                "type": "integer"
                                                                                                            },
                                                                                                            "delete": {
                                                                                                                "type": "integer"
                                                                                                            }
                                                                                                        }
                                                                                                    },
                                                                                                    "synchronization": {
                                                                                                        "type": "object",
                                                                                                        "properties": {
                                                                                                            "total": {
                                                                                                                "type": "integer"
                                                                                                            },
                                                                                                            "operation": {
                                                                                                                "type": "object",
                                                                                                                "properties": {
                                                                                                                    "open": {
                                                                                                                        "type": "integer"
                                                                                                                    },
                                                                                                                    "create": {
                                                                                                                        "type": "integer"
                                                                                                                    }
                                                                                                                }
                                                                                                            },
                                                                                                            "type": {
                                                                                                                "type": "object",
                                                                                                                "properties": {
                                                                                                                    "mutex": {
                                                                                                                        "type": "integer"
                                                                                                                    },
                                                                                                                    "event": {
                                                                                                                        "type": "integer"
                                                                                                                    }
                                                                                                                }
                                                                                                            }
                                                                                                        }
                                                                                                    }
                                                                                                }
                                                                                            },
                                                                                            "malconf": {
                                                                                                "type": "array"
                                                                                            },
                                                                                            "mitre": {
                                                                                                "type": "array"
                                                                                            },
                                                                                            "status": {
                                                                                                "type": "string"
                                                                                            }
                                                                                        }
                                                                                    }
                                                                                }
                                                                            }
                                                                        }
                                                                    },
                                                                    "Select_Tags": {
                                                                        "runAfter": {
                                                                            "Parse_JSON_-_ANYRUN_Report": [
                                                                                "Succeeded"
                                                                            ]
                                                                        },
                                                                        "type": "Select",
                                                                        "inputs": {
                                                                            "from": "@body('Parse_JSON_-_ANYRUN_Report')?['data']?['analysis']?['tags']",
                                                                            "select": "@concat(item()?['tag'], ' - ANY.RUN')"
                                                                        }
                                                                    },
                                                                    "Compose_-_All_Tags_File": {
                                                                        "runAfter": {
                                                                            "Select_Tags": [
                                                                                "Succeeded"
                                                                            ]
                                                                        },
                                                                        "type": "Compose",
                                                                        "inputs": "@union(body('Select_Tags'), createArray('ANY.RUN'))"
                                                                    },
                                                                    "For_each_-_Add_Tags_File": {
                                                                        "foreach": "@outputs('Compose_-_All_Tags_File')",
                                                                        "actions": {
                                                                            "Update_incident_-_Add_Tags": {
                                                                                "type": "ApiConnection",
                                                                                "inputs": {
                                                                                    "host": {
                                                                                        "connection": {
                                                                                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                                                                        }
                                                                                    },
                                                                                    "method": "put",
                                                                                    "body": {
                                                                                        "incidentArmId": "@triggerBody()?['object']?['id']",
                                                                                        "tagsToAdd": {
                                                                                            "TagsToAdd": "@items('For_each_-_Add_Tags_File')"
                                                                                        }
                                                                                    },
                                                                                    "path": "/Incidents"
                                                                                }
                                                                            }
                                                                        },
                                                                        "runAfter": {
                                                                            "Compose_-_All_Tags_File": [
                                                                                "Succeeded"
                                                                            ]
                                                                        },
                                                                        "type": "Foreach"
                                                                    },
                                                                    "HTTP-GetIOC": {
                                                                        "runAfter": {
                                                                            "For_each_-_Add_Tags_File": [
                                                                                "Succeeded"
                                                                            ]
                                                                        },
                                                                        "type": "Http",
                                                                        "inputs": {
                                                                            "uri": "https://api.any.run/report/@{variables('UUID')}/ioc/json",
                                                                            "method": "GET",
                                                                            "headers": {
                                                                                "Authorization": "API-Key @{body('Get_secret_-_ANYRUN')?['value']}",
                                                                                "x-anyrun-connector": "@concat('MS_Sentinel:', variables('Connector Version'))"
                                                                            }
                                                                        },
                                                                        "runtimeConfiguration": {
                                                                            "contentTransfer": {
                                                                                "transferMode": "Chunked"
                                                                            }
                                                                        }
                                                                    },
                                                                    "Parse_JSON_-_IOC": {
                                                                        "runAfter": {
                                                                            "HTTP-GetIOC": [
                                                                                "Succeeded"
                                                                            ]
                                                                        },
                                                                        "type": "ParseJson",
                                                                        "inputs": {
                                                                            "content": "@body('HTTP-GetIOC')",
                                                                            "schema": {
                                                                                "type": "array",
                                                                                "items": {
                                                                                    "type": "object",
                                                                                    "properties": {
                                                                                        "category": {
                                                                                            "type": "string"
                                                                                        },
                                                                                        "type": {
                                                                                            "type": "string"
                                                                                        },
                                                                                        "name": {
                                                                                            "type": "string"
                                                                                        },
                                                                                        "ioc": {
                                                                                            "type": "string"
                                                                                        },
                                                                                        "reputation": {
                                                                                            "type": "integer"
                                                                                        },
                                                                                        "discoveringEntryId": {
                                                                                            "type": "string"
                                                                                        }
                                                                                    }
                                                                                }
                                                                            }
                                                                        }
                                                                    },
                                                                    "Transform_IOC_Reputation": {
                                                                        "runAfter": {
                                                                            "Parse_JSON_-_IOC": [
                                                                                "Succeeded"
                                                                            ]
                                                                        },
                                                                        "type": "Select",
                                                                        "inputs": {
                                                                            "from": "@body('Parse_JSON_-_IOC')",
                                                                            "select": {
                                                                                "ioc": "@item()?['ioc']",
                                                                                "type": "@item()?['type']",
                                                                                "severity": "@if(equals(item()['reputation'], 0), 'Low', if(equals(item()['reputation'], 1), 'Suspicious', if(equals(item()['reputation'], 2), 'Malicious', 'Low')))"
                                                                            }
                                                                        }
                                                                    },
                                                                    "Filter_Malicious_IOCs": {
                                                                        "runAfter": {
                                                                            "Transform_IOC_Reputation": [
                                                                                "Succeeded"
                                                                            ]
                                                                        },
                                                                        "type": "Query",
                                                                        "inputs": {
                                                                            "from": "@body('Transform_IOC_Reputation')",
                                                                            "where": "@equals(item()['severity'], 'Malicious')"
                                                                        }
                                                                    },
                                                                    "Filter_Suspicious_IOCs": {
                                                                        "runAfter": {
                                                                            "Transform_IOC_Reputation": [
                                                                                "Succeeded"
                                                                            ]
                                                                        },
                                                                        "type": "Query",
                                                                        "inputs": {
                                                                            "from": "@body('Transform_IOC_Reputation')",
                                                                            "where": "@equals(item()['severity'], 'Suspicious')"
                                                                        }
                                                                    },
                                                                    "Filter_Unknown_IOCs": {
                                                                        "runAfter": {
                                                                            "Transform_IOC_Reputation": [
                                                                                "Succeeded"
                                                                            ]
                                                                        },
                                                                        "type": "Query",
                                                                        "inputs": {
                                                                            "from": "@body('Transform_IOC_Reputation')",
                                                                            "where": "@equals(item()['severity'], 'Low')"
                                                                        }
                                                                    },
                                                                    "Condition_-_Malicious_IOCs_is_null": {
                                                                        "actions": {
                                                                            "Filter_Malicious_IOCs_-_ip": {
                                                                                "type": "Query",
                                                                                "inputs": {
                                                                                    "from": "@body('Filter_Malicious_IOCs')",
                                                                                    "where": "@equals(item()['type'], 'ip')"
                                                                                }
                                                                            },
                                                                            "Filter_Malicious_IOCs_-_domain": {
                                                                                "type": "Query",
                                                                                "inputs": {
                                                                                    "from": "@body('Filter_Malicious_IOCs')",
                                                                                    "where": "@equals(item()['type'], 'domain')"
                                                                                }
                                                                            },
                                                                            "Filter_Malicious_IOCs_-_URL": {
                                                                                "type": "Query",
                                                                                "inputs": {
                                                                                    "from": "@body('Filter_Malicious_IOCs')",
                                                                                    "where": "@equals(item()['type'], 'url')"
                                                                                }
                                                                            },
                                                                            "Filter_Malicious_IOCs_-_hash": {
                                                                                "type": "Query",
                                                                                "inputs": {
                                                                                    "from": "@body('Filter_Malicious_IOCs')",
                                                                                    "where": "@equals(item()['type'], 'sha256')"
                                                                                }
                                                                            },
                                                                            "Select_Malicious_IOCs_-_hash": {
                                                                                "runAfter": {
                                                                                    "Filter_Malicious_IOCs_-_hash": [
                                                                                        "Succeeded"
                                                                                    ]
                                                                                },
                                                                                "type": "Select",
                                                                                "inputs": {
                                                                                    "from": "@body('Filter_Malicious_IOCs_-_hash')",
                                                                                    "select": "@item()?['ioc']"
                                                                                }
                                                                            },
                                                                            "Transform_Malicious_IOCs_to_STIX_-_hash": {
                                                                                "runAfter": {
                                                                                    "Select_Malicious_IOCs_-_hash": [
                                                                                        "Succeeded"
                                                                                    ]
                                                                                },
                                                                                "type": "Select",
                                                                                "inputs": {
                                                                                    "from": "@body('Select_Malicious_IOCs_-_hash')",
                                                                                    "select": {
                                                                                        "type": "indicator",
                                                                                        "spec_version": 2.1,
                                                                                        "id": "@concat('indicator--', guid())",
                                                                                        "created": "@utcNow('yyyy-MM-ddTHH:mm:ssZ')",
                                                                                        "modified": "@utcNow('yyyy-MM-ddTHH:mm:ssZ')",
                                                                                        "pattern": "@concat('[file:hashes.''SHA-256'' = ''', item(), ''']')",
                                                                                        "pattern_type": "stix",
                                                                                        "valid_from": "@utcNow('yyyy-MM-ddTHH:mm:ssZ')",
                                                                                        "valid_until": "@addDays(utcNow(), 365, 'yyyy-MM-ddTHH:mm:ssZ')",
                                                                                        "description": "https://app.any.run/tasks/",
                                                                                        "confidence": 100
                                                                                    }
                                                                                }
                                                                            },
                                                                            "Compose_-_STIX_objects_of_Malicious_IOCs_to_TI": {
                                                                                "runAfter": {
                                                                                    "Transform_Malicious_IOCs_to_STIX_-_hash": [
                                                                                        "Succeeded"
                                                                                    ],
                                                                                    "Transform_Malicious_IOCs_to_STIX_-_ip": [
                                                                                        "Succeeded"
                                                                                    ],
                                                                                    "Transform_Malicious_IOCs_to_STIX_-_domain": [
                                                                                        "Succeeded"
                                                                                    ],
                                                                                    "Transform_Malicious_IOCs_to_STIX_-_URL": [
                                                                                        "Succeeded"
                                                                                    ]
                                                                                },
                                                                                "type": "Compose",
                                                                                "inputs": "@union(if(greater(length(body('Transform_Malicious_IOCs_to_STIX_-_hash')), 0), body('Transform_Malicious_IOCs_to_STIX_-_hash'), json('[]')), if(greater(length(body('Transform_Malicious_IOCs_to_STIX_-_ip')), 0), body('Transform_Malicious_IOCs_to_STIX_-_ip'), json('[]')), if(greater(length(body('Transform_Malicious_IOCs_to_STIX_-_domain')), 0), body('Transform_Malicious_IOCs_to_STIX_-_domain'), json('[]')), if(greater(length(body('Transform_Malicious_IOCs_to_STIX_-_URL')), 0), body('Transform_Malicious_IOCs_to_STIX_-_URL'), json('[]')))"
                                                                            },
                                                                            "Select_Malicious_IOCs_-_ip": {
                                                                                "runAfter": {
                                                                                    "Filter_Malicious_IOCs_-_ip": [
                                                                                        "Succeeded"
                                                                                    ]
                                                                                },
                                                                                "type": "Select",
                                                                                "inputs": {
                                                                                    "from": "@body('Filter_Malicious_IOCs_-_ip')",
                                                                                    "select": "@item()?['ioc']"
                                                                                }
                                                                            },
                                                                            "Transform_Malicious_IOCs_to_STIX_-_ip": {
                                                                                "runAfter": {
                                                                                    "Select_Malicious_IOCs_-_ip": [
                                                                                        "Succeeded"
                                                                                    ]
                                                                                },
                                                                                "type": "Select",
                                                                                "inputs": {
                                                                                    "from": "@body('Select_Malicious_IOCs_-_ip')",
                                                                                    "select": {
                                                                                        "type": "indicator",
                                                                                        "spec_version": 2.1,
                                                                                        "id": "@concat('indicator--', guid())",
                                                                                        "created": "@utcNow('yyyy-MM-ddTHH:mm:ssZ')",
                                                                                        "modified": "@utcNow('yyyy-MM-ddTHH:mm:ssZ')",
                                                                                        "pattern": "@concat('[ipv4-addr:value = ''', item(), ''']')",
                                                                                        "pattern_type": "stix",
                                                                                        "valid_from": "@utcNow('yyyy-MM-ddTHH:mm:ssZ')",
                                                                                        "valid_until": "@addDays(utcNow(), 365, 'yyyy-MM-ddTHH:mm:ssZ')",
                                                                                        "description": "https://app.any.run/tasks/",
                                                                                        "confidence": 100
                                                                                    }
                                                                                }
                                                                            },
                                                                            "Select_Malicious_IOCs_-_domain": {
                                                                                "runAfter": {
                                                                                    "Filter_Malicious_IOCs_-_domain": [
                                                                                        "Succeeded"
                                                                                    ]
                                                                                },
                                                                                "type": "Select",
                                                                                "inputs": {
                                                                                    "from": "@body('Filter_Malicious_IOCs_-_domain')",
                                                                                    "select": "@item()?['ioc']"
                                                                                }
                                                                            },
                                                                            "Transform_Malicious_IOCs_to_STIX_-_domain": {
                                                                                "runAfter": {
                                                                                    "Select_Malicious_IOCs_-_domain": [
                                                                                        "Succeeded"
                                                                                    ]
                                                                                },
                                                                                "type": "Select",
                                                                                "inputs": {
                                                                                    "from": "@body('Select_Malicious_IOCs_-_domain')",
                                                                                    "select": {
                                                                                        "type": "indicator",
                                                                                        "spec_version": 2.1,
                                                                                        "id": "@concat('indicator--', guid())",
                                                                                        "created": "@utcNow('yyyy-MM-ddTHH:mm:ssZ')",
                                                                                        "modified": "@utcNow('yyyy-MM-ddTHH:mm:ssZ')",
                                                                                        "pattern": "@concat('[domain-name:value = ''', item(), ''']')",
                                                                                        "pattern_type": "stix",
                                                                                        "valid_from": "@utcNow('yyyy-MM-ddTHH:mm:ssZ')",
                                                                                        "valid_until": "@addDays(utcNow(), 365, 'yyyy-MM-ddTHH:mm:ssZ')",
                                                                                        "description": "https://app.any.run/tasks/",
                                                                                        "confidence": 100
                                                                                    }
                                                                                }
                                                                            },
                                                                            "Select_Malicious_IOCs_-_URL": {
                                                                                "runAfter": {
                                                                                    "Filter_Malicious_IOCs_-_URL": [
                                                                                        "Succeeded"
                                                                                    ]
                                                                                },
                                                                                "type": "Select",
                                                                                "inputs": {
                                                                                    "from": "@body('Filter_Malicious_IOCs_-_URL')",
                                                                                    "select": "@item()?['ioc']"
                                                                                }
                                                                            },
                                                                            "Transform_Malicious_IOCs_to_STIX_-_URL": {
                                                                                "runAfter": {
                                                                                    "Select_Malicious_IOCs_-_URL": [
                                                                                        "Succeeded"
                                                                                    ]
                                                                                },
                                                                                "type": "Select",
                                                                                "inputs": {
                                                                                    "from": "@body('Select_Malicious_IOCs_-_URL')",
                                                                                    "select": {
                                                                                        "type": "indicator",
                                                                                        "spec_version": 2.1,
                                                                                        "id": "@concat('indicator--', guid())",
                                                                                        "created": "@utcNow('yyyy-MM-ddTHH:mm:ssZ')",
                                                                                        "modified": "@utcNow('yyyy-MM-ddTHH:mm:ssZ')",
                                                                                        "pattern": "@concat('[url:value = ''', item(), ''']')",
                                                                                        "pattern_type": "stix",
                                                                                        "valid_from": "@utcNow('yyyy-MM-ddTHH:mm:ssZ')",
                                                                                        "valid_until": "@addDays(utcNow(), 365, 'yyyy-MM-ddTHH:mm:ssZ')",
                                                                                        "description": "https://app.any.run/tasks/",
                                                                                        "confidence": 100
                                                                                    }
                                                                                }
                                                                            },
                                                                            "Select_-_Chunk_Malicious_IOCs_array": {
                                                                                "runAfter": {
                                                                                    "Compose_-_STIX_objects_of_Malicious_IOCs_to_TI": [
                                                                                        "Succeeded"
                                                                                    ]
                                                                                },
                                                                                "type": "Select",
                                                                                "inputs": {
                                                                                    "from": "@range(0, add(div(length(outputs('Compose_-_STIX_objects_of_Malicious_IOCs_to_TI')), 99), if(equals(mod(length(outputs('Compose_-_STIX_objects_of_Malicious_IOCs_to_TI')), 99), 0), 0, 1)))",
                                                                                    "select": "@take(skip(outputs('Compose_-_STIX_objects_of_Malicious_IOCs_to_TI'), mul(item(), 99)), 99)"
                                                                                }
                                                                            },
                                                                            "For_each_-_Upload_Malicious_IOCs": {
                                                                                "foreach": "@outputs('Select_-_Chunk_Malicious_IOCs_array')['body']",
                                                                                "actions": {
                                                                                    "Threat_Intelligence_-_Upload_Indicators_of_Compromise_(V2)_-_Malicious_IOCs": {
                                                                                        "type": "ApiConnection",
                                                                                        "inputs": {
                                                                                            "host": {
                                                                                                "connection": {
                                                                                                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                                                                                }
                                                                                            },
                                                                                            "method": "post",
                                                                                            "body": {
                                                                                                "sourcesystem": "ANY.RUN-Sandbox",
                                                                                                "indicators": "@item()"
                                                                                            },
                                                                                            "path": "/V2/ThreatIntelligence/@{encodeURIComponent(triggerBody()?['workspaceId'])}/UploadIndicators/"
                                                                                        }
                                                                                    }
                                                                                },
                                                                                "runAfter": {
                                                                                    "Select_-_Chunk_Malicious_IOCs_array": [
                                                                                        "Succeeded"
                                                                                    ]
                                                                                },
                                                                                "type": "Foreach"
                                                                            }
                                                                        },
                                                                        "runAfter": {
                                                                            "Filter_Malicious_IOCs": [
                                                                                "Succeeded"
                                                                            ]
                                                                        },
                                                                        "else": {
                                                                            "actions": {}
                                                                        },
                                                                        "expression": {
                                                                            "and": [
                                                                                {
                                                                                    "not": {
                                                                                        "equals": [
                                                                                            "@body('Filter_Malicious_IOCs')",
                                                                                            ""
                                                                                        ]
                                                                                    }
                                                                                }
                                                                            ]
                                                                        },
                                                                        "type": "If"
                                                                    },
                                                                    "Condition_-_Suspicious_IOCs_is_null": {
                                                                        "actions": {
                                                                            "Filter_Suspicious_IOCs_-_ip": {
                                                                                "type": "Query",
                                                                                "inputs": {
                                                                                    "from": "@body('Filter_Suspicious_IOCs')",
                                                                                    "where": "@equals(item()['type'], 'ip')"
                                                                                }
                                                                            },
                                                                            "Filter_Suspicious_IOCs_-_domain": {
                                                                                "type": "Query",
                                                                                "inputs": {
                                                                                    "from": "@body('Filter_Suspicious_IOCs')",
                                                                                    "where": "@equals(item()['type'], 'domain')"
                                                                                }
                                                                            },
                                                                            "Filter_Suspicious_IOCs_-_URL": {
                                                                                "type": "Query",
                                                                                "inputs": {
                                                                                    "from": "@body('Filter_Suspicious_IOCs')",
                                                                                    "where": "@equals(item()['type'], 'url')"
                                                                                }
                                                                            },
                                                                            "Filter_Suspicious_IOCs_-_hash": {
                                                                                "type": "Query",
                                                                                "inputs": {
                                                                                    "from": "@body('Filter_Suspicious_IOCs')",
                                                                                    "where": "@equals(item()['type'], 'sha256')"
                                                                                }
                                                                            },
                                                                            "Select_Suspicious_IOCs_-_hash": {
                                                                                "runAfter": {
                                                                                    "Filter_Suspicious_IOCs_-_hash": [
                                                                                        "Succeeded"
                                                                                    ]
                                                                                },
                                                                                "type": "Select",
                                                                                "inputs": {
                                                                                    "from": "@body('Filter_Suspicious_IOCs_-_hash')",
                                                                                    "select": "@item()?['ioc']"
                                                                                }
                                                                            },
                                                                            "Transform_Suspicious_IOCs_to_STIX_-_hash": {
                                                                                "runAfter": {
                                                                                    "Select_Suspicious_IOCs_-_hash": [
                                                                                        "Succeeded"
                                                                                    ]
                                                                                },
                                                                                "type": "Select",
                                                                                "inputs": {
                                                                                    "from": "@body('Select_Suspicious_IOCs_-_hash')",
                                                                                    "select": {
                                                                                        "type": "indicator",
                                                                                        "spec_version": 2.1,
                                                                                        "id": "@concat('indicator--', guid())",
                                                                                        "created": "@utcNow('yyyy-MM-ddTHH:mm:ssZ')",
                                                                                        "modified": "@utcNow('yyyy-MM-ddTHH:mm:ssZ')",
                                                                                        "pattern": "@concat('[file:hashes.''SHA-256'' = ''', item(), ''']')",
                                                                                        "pattern_type": "stix",
                                                                                        "valid_from": "@utcNow('yyyy-MM-ddTHH:mm:ssZ')",
                                                                                        "valid_until": "@addDays(utcNow(), 365, 'yyyy-MM-ddTHH:mm:ssZ')",
                                                                                        "description": "https://app.any.run/tasks/",
                                                                                        "confidence": 50
                                                                                    }
                                                                                }
                                                                            },
                                                                            "Compose_-_STIX_objects_of_Suspicious_IOCs_to_TI": {
                                                                                "runAfter": {
                                                                                    "Transform_Suspicious_IOCs_to_STIX_-_hash": [
                                                                                        "Succeeded"
                                                                                    ],
                                                                                    "Transform_Suspicious_IOCs_to_STIX_-_ip": [
                                                                                        "Succeeded"
                                                                                    ],
                                                                                    "Transform_Suspicious_IOCs_to_STIX_-_domain": [
                                                                                        "Succeeded"
                                                                                    ],
                                                                                    "Transform_Suspicious_IOCs_to_STIX_-_URL": [
                                                                                        "Succeeded"
                                                                                    ]
                                                                                },
                                                                                "type": "Compose",
                                                                                "inputs": "@union(if(greater(length(body('Transform_Suspicious_IOCs_to_STIX_-_hash')), 0), body('Transform_Suspicious_IOCs_to_STIX_-_hash'), json('[]')), if(greater(length(body('Transform_Suspicious_IOCs_to_STIX_-_ip')), 0), body('Transform_Suspicious_IOCs_to_STIX_-_ip'), json('[]')), if(greater(length(body('Transform_Suspicious_IOCs_to_STIX_-_domain')), 0), body('Transform_Suspicious_IOCs_to_STIX_-_domain'), json('[]')), if(greater(length(body('Transform_Suspicious_IOCs_to_STIX_-_URL')), 0), body('Transform_Suspicious_IOCs_to_STIX_-_URL'), json('[]')))"
                                                                            },
                                                                            "Select_Suspicious_IOCs_-_ip": {
                                                                                "runAfter": {
                                                                                    "Filter_Suspicious_IOCs_-_ip": [
                                                                                        "Succeeded"
                                                                                    ]
                                                                                },
                                                                                "type": "Select",
                                                                                "inputs": {
                                                                                    "from": "@body('Filter_Suspicious_IOCs_-_ip')",
                                                                                    "select": "@item()?['ioc']"
                                                                                }
                                                                            },
                                                                            "Transform_Suspicious_IOCs_to_STIX_-_ip": {
                                                                                "runAfter": {
                                                                                    "Select_Suspicious_IOCs_-_ip": [
                                                                                        "Succeeded"
                                                                                    ]
                                                                                },
                                                                                "type": "Select",
                                                                                "inputs": {
                                                                                    "from": "@body('Select_Suspicious_IOCs_-_ip')",
                                                                                    "select": {
                                                                                        "type": "indicator",
                                                                                        "spec_version": 2.1,
                                                                                        "id": "@concat('indicator--', guid())",
                                                                                        "created": "@utcNow('yyyy-MM-ddTHH:mm:ssZ')",
                                                                                        "modified": "@utcNow('yyyy-MM-ddTHH:mm:ssZ')",
                                                                                        "pattern": "@concat('[ipv4-addr:value = ''', item(), ''']')",
                                                                                        "pattern_type": "stix",
                                                                                        "valid_from": "@utcNow('yyyy-MM-ddTHH:mm:ssZ')",
                                                                                        "valid_until": "@addDays(utcNow(), 365, 'yyyy-MM-ddTHH:mm:ssZ')",
                                                                                        "description": "https://app.any.run/tasks/",
                                                                                        "confidence": 50
                                                                                    }
                                                                                }
                                                                            },
                                                                            "Select_Suspicious_IOCs_-_domain": {
                                                                                "runAfter": {
                                                                                    "Filter_Suspicious_IOCs_-_domain": [
                                                                                        "Succeeded"
                                                                                    ]
                                                                                },
                                                                                "type": "Select",
                                                                                "inputs": {
                                                                                    "from": "@body('Filter_Suspicious_IOCs_-_domain')",
                                                                                    "select": "@item()?['ioc']"
                                                                                }
                                                                            },
                                                                            "Transform_Suspicious_IOCs_to_STIX_-_domain": {
                                                                                "runAfter": {
                                                                                    "Select_Suspicious_IOCs_-_domain": [
                                                                                        "Succeeded"
                                                                                    ]
                                                                                },
                                                                                "type": "Select",
                                                                                "inputs": {
                                                                                    "from": "@body('Select_Suspicious_IOCs_-_domain')",
                                                                                    "select": {
                                                                                        "type": "indicator",
                                                                                        "spec_version": 2.1,
                                                                                        "id": "@concat('indicator--', guid())",
                                                                                        "created": "@utcNow('yyyy-MM-ddTHH:mm:ssZ')",
                                                                                        "modified": "@utcNow('yyyy-MM-ddTHH:mm:ssZ')",
                                                                                        "pattern": "@concat('[domain-name:value = ''', item(), ''']')",
                                                                                        "pattern_type": "stix",
                                                                                        "valid_from": "@utcNow('yyyy-MM-ddTHH:mm:ssZ')",
                                                                                        "valid_until": "@addDays(utcNow(), 365, 'yyyy-MM-ddTHH:mm:ssZ')",
                                                                                        "description": "https://app.any.run/tasks/",
                                                                                        "confidence": 50
                                                                                    }
                                                                                }
                                                                            },
                                                                            "Select_Suspicious_IOCs_-_URL": {
                                                                                "runAfter": {
                                                                                    "Filter_Suspicious_IOCs_-_URL": [
                                                                                        "Succeeded"
                                                                                    ]
                                                                                },
                                                                                "type": "Select",
                                                                                "inputs": {
                                                                                    "from": "@body('Filter_Suspicious_IOCs_-_URL')",
                                                                                    "select": "@item()?['ioc']"
                                                                                }
                                                                            },
                                                                            "Transform_Suspicious_IOCs_to_STIX_-_URL": {
                                                                                "runAfter": {
                                                                                    "Select_Suspicious_IOCs_-_URL": [
                                                                                        "Succeeded"
                                                                                    ]
                                                                                },
                                                                                "type": "Select",
                                                                                "inputs": {
                                                                                    "from": "@body('Select_Suspicious_IOCs_-_URL')",
                                                                                    "select": {
                                                                                        "type": "indicator",
                                                                                        "spec_version": 2.1,
                                                                                        "id": "@concat('indicator--', guid())",
                                                                                        "created": "@utcNow('yyyy-MM-ddTHH:mm:ssZ')",
                                                                                        "modified": "@utcNow('yyyy-MM-ddTHH:mm:ssZ')",
                                                                                        "pattern": "@concat('[url:value = ''', item(), ''']')",
                                                                                        "pattern_type": "stix",
                                                                                        "valid_from": "@utcNow('yyyy-MM-ddTHH:mm:ssZ')",
                                                                                        "valid_until": "@addDays(utcNow(), 365, 'yyyy-MM-ddTHH:mm:ssZ')",
                                                                                        "description": "https://app.any.run/tasks/",
                                                                                        "confidence": 10
                                                                                    }
                                                                                }
                                                                            },
                                                                            "Select_-_Chunk_Suspicious_IOCs_array": {
                                                                                "runAfter": {
                                                                                    "Compose_-_STIX_objects_of_Suspicious_IOCs_to_TI": [
                                                                                        "Succeeded"
                                                                                    ]
                                                                                },
                                                                                "type": "Select",
                                                                                "inputs": {
                                                                                    "from": "@range(0, add(div(length(outputs('Compose_-_STIX_objects_of_Suspicious_IOCs_to_TI')), 99), if(equals(mod(length(outputs('Compose_-_STIX_objects_of_Suspicious_IOCs_to_TI')), 99), 0), 0, 1)))",
                                                                                    "select": "@take(skip(outputs('Compose_-_STIX_objects_of_Suspicious_IOCs_to_TI'), mul(item(), 99)), 99)"
                                                                                }
                                                                            },
                                                                            "For_each_-_Upload_Suspicious_IOCs": {
                                                                                "foreach": "@outputs('Select_-_Chunk_Suspicious_IOCs_array')['body']",
                                                                                "actions": {
                                                                                    "Threat_Intelligence_-_Upload_Indicators_of_Compromise_(V2)_-_Suspicious_IOCs": {
                                                                                        "type": "ApiConnection",
                                                                                        "inputs": {
                                                                                            "host": {
                                                                                                "connection": {
                                                                                                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                                                                                }
                                                                                            },
                                                                                            "method": "post",
                                                                                            "body": {
                                                                                                "sourcesystem": "ANY.RUN-Sandbox",
                                                                                                "indicators": "@item()"
                                                                                            },
                                                                                            "path": "/V2/ThreatIntelligence/@{encodeURIComponent(triggerBody()?['workspaceId'])}/UploadIndicators/"
                                                                                        }
                                                                                    }
                                                                                },
                                                                                "runAfter": {
                                                                                    "Select_-_Chunk_Suspicious_IOCs_array": [
                                                                                        "Succeeded"
                                                                                    ]
                                                                                },
                                                                                "type": "Foreach"
                                                                            }
                                                                        },
                                                                        "runAfter": {
                                                                            "Filter_Suspicious_IOCs": [
                                                                                "Succeeded"
                                                                            ]
                                                                        },
                                                                        "else": {
                                                                            "actions": {}
                                                                        },
                                                                        "expression": {
                                                                            "and": [
                                                                                {
                                                                                    "not": {
                                                                                        "equals": [
                                                                                            "@body('Filter_Suspicious_IOCs')",
                                                                                            ""
                                                                                        ]
                                                                                    }
                                                                                }
                                                                            ]
                                                                        },
                                                                        "type": "If"
                                                                    },
                                                                    "Compose_Sorted_IOCs": {
                                                                        "runAfter": {
                                                                            "Condition_-_Suspicious_IOCs_is_null": [
                                                                                "Succeeded"
                                                                            ],
                                                                            "Condition_-_Malicious_IOCs_is_null": [
                                                                                "Succeeded"
                                                                            ],
                                                                            "Filter_Unknown_IOCs": [
                                                                                "Succeeded"
                                                                            ]
                                                                        },
                                                                        "type": "Compose",
                                                                        "inputs": "@union(body('Filter_Malicious_IOCs'), body('Filter_Suspicious_IOCs'), body('Filter_Unknown_IOCs'))"
                                                                    },
                                                                    "Create_IOC_Table_Rows": {
                                                                        "runAfter": {
                                                                            "Compose_Sorted_IOCs": [
                                                                                "Succeeded"
                                                                            ]
                                                                        },
                                                                        "type": "Select",
                                                                        "inputs": {
                                                                            "from": "@outputs('Compose_Sorted_IOCs')",
                                                                            "select": "<tr><td>@{item()['ioc']}</td><td>@{item()['type']}</td><td>@{item()['severity']}</td></tr>"
                                                                        }
                                                                    },
                                                                    "Compose_IOC_Table": {
                                                                        "runAfter": {
                                                                            "Create_IOC_Table_Rows": [
                                                                                "Succeeded"
                                                                            ]
                                                                        },
                                                                        "type": "Compose",
                                                                        "inputs": "<table border='1'><tr><th>IOC</th><th>Type</th><th>Severity</th></tr>@{join(body('Create_IOC_Table_Rows'), '')}</table>"
                                                                    },
                                                                    "Add_comment_to_incident_(V3)_-_ANY.RUN_Output": {
                                                                        "runAfter": {
                                                                            "Compose_IOC_Table": [
                                                                                "Succeeded"
                                                                            ]
                                                                        },
                                                                        "type": "ApiConnection",
                                                                        "inputs": {
                                                                            "host": {
                                                                                "connection": {
                                                                                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                                                                }
                                                                            },
                                                                            "method": "post",
                                                                            "body": {
                                                                                "incidentArmId": "@triggerBody()?['object']?['id']",
                                                                                "message": "<p class=\"editor-paragraph\"><b><strong class=\"editor-text-bold\">ANY.RUN File Detonation Results:</strong></b><br><span style=\"color: rgb(208, 2, 27);\">A potencial malicious File has been detected </span><span style=\"color: rgb(208, 2, 27);\">during analysis in ANY.RUN Sandbox </span>(@{items('For_each_-_Find_file_path_on_the_target_host')?['properties']?['fileName']}).</p><br><p class=\"editor-paragraph\"><b><strong class=\"editor-text-bold\">Verdict:</strong></b> @{body('Parse_JSON_-_Task_Monitor')?['task']?['scores']?['verdict']?['text']}<br><b><strong class=\"editor-text-bold\">Threat score:</strong></b> @{body('Parse_JSON_-_ANYRUN_Report')?['data']?['analysis']?['scores']?['verdict']?['score']}/100<br><b><strong class=\"editor-text-bold\">Link to interactive report:</strong></b> https://app.any.run/tasks/@{variables('UUID')}</p><br><p class=\"editor-paragraph\"><b><strong class=\"editor-text-bold\">Detected IOCs:</strong></b><br>@{outputs('Compose_IOC_Table')}</p>"
                                                                            },
                                                                            "path": "/Incidents/Comment"
                                                                        }
                                                                    }
                                                                },
                                                                "runAfter": {
                                                                    "Until_File_Analysis_is_not_completed": [
                                                                        "Succeeded"
                                                                    ]
                                                                },
                                                                "else": {
                                                                    "actions": {
                                                                        "Add_comment_to_incident_(V3)_-_CleanScan_ANY.RUN_Output": {
                                                                            "type": "ApiConnection",
                                                                            "inputs": {
                                                                                "host": {
                                                                                    "connection": {
                                                                                        "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                                                                    }
                                                                                },
                                                                                "method": "post",
                                                                                "body": {
                                                                                    "incidentArmId": "@triggerBody()?['object']?['id']",
                                                                                    "message": "<p class=\"editor-paragraph\"><b><strong class=\"editor-text-bold\">ANY.RUN File Detonation Results:</strong></b><br><span style=\"color: rgb(65, 117, 5);\">File is clean and no malicious activity was found during analysis in ANY.RUN Sandbox</span> (@{variables('Suspicious File - FileName')}).</p><p class=\"editor-paragraph\"><br><b><strong class=\"editor-text-bold\">Link to interactive report:</strong></b> https://app.any.run/tasks/@{variables('UUID')}</p>"
                                                                                },
                                                                                "path": "/Incidents/Comment"
                                                                            }
                                                                        }
                                                                    }
                                                                },
                                                                "expression": {
                                                                    "or": [
                                                                        {
                                                                            "greater": [
                                                                                "@body('Parse_JSON_-_Task_Monitor')?['task']?['scores']?['verdict']?['threat_level']",
                                                                                0
                                                                            ]
                                                                        },
                                                                        {
                                                                            "not": {
                                                                                "equals": [
                                                                                    "@body('Parse_JSON_-_Task_Monitor')?['task']?['scores']?['verdict']?['text']",
                                                                                    "No threats detected"
                                                                                ]
                                                                            }
                                                                        }
                                                                    ]
                                                                },
                                                                "type": "If"
                                                            }
                                                        }
                                                    },
                                                    "expression": {
                                                        "or": [
                                                            {
                                                                "contains": [
                                                                    "@body('Parse_JSON_-_Parse_Script_Output')?['script_errors']",
                                                                    "FullyQualifiedErrorId"
                                                                ]
                                                            },
                                                            {
                                                                "not": {
                                                                    "contains": [
                                                                        "@body('Parse_JSON_-_Parse_Script_Output')?['script_output']",
                                                                        "File uploaded to Blob Storage successfully"
                                                                    ]
                                                                }
                                                            }
                                                        ]
                                                    },
                                                    "type": "If"
                                                },
                                                "Add_comment_to_incident_-_Pending_Live_Response_Response": {
                                                    "runAfter": {
                                                        "Until_-_Wait_Live_Response_Completion": [
                                                            "Failed"
                                                        ]
                                                    },
                                                    "type": "ApiConnection",
                                                    "inputs": {
                                                        "host": {
                                                            "connection": {
                                                                "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                                            }
                                                        },
                                                        "method": "post",
                                                        "body": {
                                                            "incidentArmId": "@triggerBody()?['object']?['id']",
                                                            "message": "<p class=\"editor-paragraph\">Live response session has been pending for 1hr after multiple attempts to initiate the live response and await a response. Terminating the session due to a possibly offline device.</p><br><p class=\"editor-paragraph\"><b><strong class=\"editor-text-bold\">Device ID:</strong></b> @{body('Parse_JSON_-_Each_Host')?['additionalData']?['MdatpDeviceId']}</p><br><p class=\"editor-paragraph\"><b><strong class=\"editor-text-bold\">Live Response URI:</strong></b> https://api.securitycenter.microsoft.com/api/machineactions//GetLiveResponseResultDownloadLink(index=0)</p>"
                                                        },
                                                        "path": "/Incidents/Comment"
                                                    }
                                                },
                                                "Set_variable_-_IsPending_Live_Response_Result": {
                                                    "runAfter": {
                                                        "Add_comment_to_incident_-_Pending_Live_Response_Response": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "SetVariable",
                                                    "inputs": {
                                                        "name": "Error Handeling",
                                                        "value": true
                                                    }
                                                },
                                                "Delay_-_Wait_for_next_live_response_session": {
                                                    "type": "Wait",
                                                    "inputs": {
                                                        "interval": {
                                                            "count": 1,
                                                            "unit": "Minute"
                                                        }
                                                    }
                                                },
                                                "HTTP_-_Generate_SAS_Token": {
                                                    "runAfter": {
                                                        "Delay_-_Wait_for_next_live_response_session": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "Http",
                                                    "inputs": {
                                                        "uri": "@concat('https://management.azure.com/subscriptions/', variables('Subscription ID'), '/resourceGroups/', variables('Resource Group Name'), '/providers/Microsoft.Storage/storageAccounts/', variables('Storage Account Name'), '/listServiceSas?api-version=2021-04-01')",
                                                        "method": "POST",
                                                        "body": {
                                                            "canonicalizedResource": "@concat('/blob/', variables('Storage Account Name'), '/', variables('Container Name'))",
                                                            "signedResource": "c",
                                                            "signedPermission": "racw",
                                                            "signedProtocol": "https",
                                                            "signedExpiry": "@addToTime(utcNow(), 2, 'Hour')"
                                                        },
                                                        "authentication": {
                                                            "type": "ManagedServiceIdentity"
                                                        }
                                                    }
                                                },
                                                "Parse_JSON_-_SAS_Token": {
                                                    "runAfter": {
                                                        "HTTP_-_Generate_SAS_Token": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "ParseJson",
                                                    "inputs": {
                                                        "content": "@body('HTTP_-_Generate_SAS_Token')",
                                                        "schema": {
                                                            "type": "object",
                                                            "properties": {
                                                                "serviceSasToken": {
                                                                    "type": "string"
                                                                }
                                                            }
                                                        }
                                                    }
                                                },
                                                "Compose_-_SAS_Token": {
                                                    "runAfter": {
                                                        "Parse_JSON_-_SAS_Token": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "Compose",
                                                    "inputs": "@body('Parse_JSON_-_SAS_Token')?['serviceSasToken']"
                                                },
                                                "Actions_-_Run_live_response": {
                                                    "runAfter": {
                                                        "Condition_-_Windows_Machine": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "ApiConnection",
                                                    "inputs": {
                                                        "host": {
                                                            "connection": {
                                                                "name": "@parameters('$connections')['wdatp']['connectionId']"
                                                            }
                                                        },
                                                        "method": "post",
                                                        "body": {
                                                            "Comment": "Live Response to upload suspicious file to Blob Stotage",
                                                            "Commands": [
                                                                {
                                                                    "type": "RunScript",
                                                                    "params": [
                                                                        {
                                                                            "key": "ScriptName",
                                                                            "value": "@{variables('Script Name')}"
                                                                        },
                                                                        {
                                                                            "key": "Args",
                                                                            "value": "@{variables('Script Parameters')}"
                                                                        }
                                                                    ]
                                                                }
                                                            ]
                                                        },
                                                        "path": "/api/machines/@{encodeURIComponent(body('Parse_JSON_-_Each_Host')?['additionalData']?['MdatpDeviceId'])}/runliveresponse"
                                                    }
                                                },
                                                "Actions_-_Get_live_response_command_result_download_URI": {
                                                    "runAfter": {
                                                        "Until_-_Wait_Live_Response_Completion": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "ApiConnection",
                                                    "inputs": {
                                                        "host": {
                                                            "connection": {
                                                                "name": "@parameters('$connections')['wdatp']['connectionId']"
                                                            }
                                                        },
                                                        "method": "get",
                                                        "path": "/api/machineactions/@{encodeURIComponent(body('Actions_-_Get_single_machine_action')?['id'])}/GetLiveResponseResultDownloadLink(index=@{encodeURIComponent('0')})"
                                                    }
                                                },
                                                "Machines_-_Get_single_machine": {
                                                    "runAfter": {
                                                        "Compose_-_SAS_Token": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "ApiConnection",
                                                    "inputs": {
                                                        "host": {
                                                            "connection": {
                                                                "name": "@parameters('$connections')['wdatp']['connectionId']"
                                                            }
                                                        },
                                                        "method": "get",
                                                        "path": "/api/machines/@{encodeURIComponent(body('Parse_JSON_-_Each_Host')?['additionalData']?['MdatpDeviceId'])}"
                                                    }
                                                },
                                                "Condition_-_Windows_Machine": {
                                                    "actions": {
                                                        "Set_variable_-_Windows_OS_Script_Name": {
                                                            "type": "SetVariable",
                                                            "inputs": {
                                                                "name": "Script Name",
                                                                "value": "ANYRUN-QUARANTINE-TO-BLOB.ps1"
                                                            }
                                                        },
                                                        "Set_variable_-_Windows_OS_Script_Parameters": {
                                                            "runAfter": {
                                                                "Set_variable_-_Windows_OS_Script_Name": [
                                                                    "Succeeded"
                                                                ]
                                                            },
                                                            "type": "SetVariable",
                                                            "inputs": {
                                                                "name": "Script Parameters",
                                                                "value": "-filePath @{variables('Suspicious File - FilePath')} -SAStoken '@{replace(outputs('Compose_-_SAS_Token'), '&', '^&')}' -storageAccountName @{variables('Storage Account Name')} -containerName @{variables('Container Name')}"
                                                            }
                                                        }
                                                    },
                                                    "runAfter": {
                                                        "Machines_-_Get_single_machine": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "else": {
                                                        "actions": {
                                                            "Set_variable_-_UNIX_OS_Script_Name": {
                                                                "type": "SetVariable",
                                                                "inputs": {
                                                                    "name": "Script Name",
                                                                    "value": "ANYRUN-QUARANTINE-TO-BLOB.sh"
                                                                }
                                                            },
                                                            "Set_variable_-_UNIX_OS_Script_Parameters": {
                                                                "runAfter": {
                                                                    "Set_variable_-_UNIX_OS_Script_Name": [
                                                                        "Succeeded"
                                                                    ]
                                                                },
                                                                "type": "SetVariable",
                                                                "inputs": {
                                                                    "name": "Script Parameters",
                                                                    "value": "\"@{replace(variables('Suspicious File - FilePath'),'\\','/')}\" \"@{outputs('Compose_-_SAS_Token')}\" \"@{variables('Storage Account Name')}\" \"@{variables('Container Name')}\""
                                                                }
                                                            }
                                                        }
                                                    },
                                                    "expression": {
                                                        "and": [
                                                            {
                                                                "contains": [
                                                                    "@body('Machines_-_Get_single_machine')?['osPlatform']",
                                                                    "Windows"
                                                                ]
                                                            }
                                                        ]
                                                    },
                                                    "type": "If"
                                                }
                                            },
                                            "runAfter": {
                                                "For_each_-_Set_Folder_Path": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "else": {
                                                "actions": {
                                                    "Add_comment_to_incident_(V3)_-_KQL_Result_is_empty": {
                                                        "type": "ApiConnection",
                                                        "inputs": {
                                                            "host": {
                                                                "connection": {
                                                                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                                                }
                                                            },
                                                            "method": "post",
                                                            "body": {
                                                                "incidentArmId": "@triggerBody()?['object']?['id']",
                                                                "message": "<p class=\"editor-paragraph\"><b><strong class=\"editor-text-bold\">The file was not found at the host.</strong></b></p><br><p class=\"editor-paragraph\">No antivirus alerts with the specified file name \"@{items('For_each_-_Find_file_path_on_the_target_host')?['properties']?['fileName']}\" were found on the host. Please check your query parameters.</p>"
                                                            },
                                                            "path": "/Incidents/Comment"
                                                        }
                                                    }
                                                }
                                            },
                                            "expression": {
                                                "and": [
                                                    {
                                                        "equals": [
                                                            "@empty(body('KQL_-_Get_FilePath')?['value'])",
                                                            false
                                                        ]
                                                    }
                                                ]
                                            },
                                            "type": "If"
                                        }
                                    },
                                    "runAfter": {
                                        "Parse_JSON_-_Each_Host": [
                                            "Succeeded"
                                        ]
                                    },
                                    "type": "Foreach"
                                },
                                "Actions_-_Run_antivirus_scan": {
                                    "runAfter": {
                                        "Parse_JSON_-_Each_Host": [
                                            "Succeeded"
                                        ]
                                    },
                                    "type": "ApiConnection",
                                    "inputs": {
                                        "host": {
                                            "connection": {
                                                "name": "@parameters('$connections')['wdatp']['connectionId']"
                                            }
                                        },
                                        "method": "post",
                                        "body": {
                                            "Comment": "Scanning this device as part of sentinel incident - @{triggerBody()?['object']?['properties']?['incidentNumber']}",
                                            "ScanType": "Full"
                                        },
                                        "path": "/api/machines/@{encodeURIComponent(body('Parse_JSON_-_Each_Host')?['additionalData']?['MdatpDeviceId'])}/runAntiVirusScan"
                                    }
                                },
                                "Parse_JSON_-_Each_Host": {
                                    "type": "ParseJson",
                                    "inputs": {
                                        "content": "@items('For_each_-_Host')",
                                        "schema": {
                                            "type": "object",
                                            "properties": {
                                                "hostName": {
                                                    "type": "string"
                                                },
                                                "additionalData": {
                                                    "type": "object",
                                                    "properties": {
                                                        "MdatpDeviceId": {
                                                            "type": "string"
                                                        }
                                                    }
                                                },
                                                "friendlyName": {
                                                    "type": "string"
                                                }
                                            }
                                        }
                                    }
                                },
                                "Add_comment_to_incident_(V3)_-_Pending_Anti_Virus_Scan": {
                                    "runAfter": {
                                        "Actions_-_Run_antivirus_scan": [
                                            "Failed"
                                        ]
                                    },
                                    "type": "ApiConnection",
                                    "inputs": {
                                        "host": {
                                            "connection": {
                                                "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                            }
                                        },
                                        "method": "post",
                                        "body": {
                                            "incidentArmId": "@triggerBody()?['object']?['id']",
                                            "message": "<p class=\"editor-paragraph\">Anti-virus scan is currently pending. Possibly due to the device being offline or connectivity issues.<br></p><br>"
                                        },
                                        "path": "/Incidents/Comment"
                                    }
                                },
                                "Set_variable_-_IsPending_Scan": {
                                    "runAfter": {
                                        "Add_comment_to_incident_(V3)_-_Pending_Anti_Virus_Scan": [
                                            "Succeeded"
                                        ]
                                    },
                                    "type": "SetVariable",
                                    "inputs": {
                                        "name": "Error Handeling",
                                        "value": true
                                    }
                                }
                            },
                            "runAfter": {
                                "For_each_-_URLs": [
                                    "Succeeded",
                                    "TimedOut",
                                    "Skipped",
                                    "Failed"
                                ]
                            },
                            "type": "Foreach"
                        },
                        "Entities_-_Get_URLs": {
                            "runAfter": {
                                "Entities_-_Get_Hosts": [
                                    "Succeeded"
                                ]
                            },
                            "type": "ApiConnection",
                            "inputs": {
                                "host": {
                                    "connection": {
                                        "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                    }
                                },
                                "method": "post",
                                "body": "@triggerBody()?['object']?['properties']?['relatedEntities']",
                                "path": "/entities/url"
                            }
                        },
                        "Condition_-_Are_actions_currently_pending": {
                            "actions": {
                                "Terminate": {
                                    "type": "Terminate",
                                    "inputs": {
                                        "runStatus": "Cancelled"
                                    }
                                }
                            },
                            "runAfter": {
                                "For_each_-_Host": [
                                    "Succeeded",
                                    "TimedOut",
                                    "Skipped",
                                    "Failed"
                                ]
                            },
                            "else": {
                                "actions": {}
                            },
                            "expression": {
                                "and": [
                                    {
                                        "equals": [
                                            "@variables('Error Handeling')",
                                            true
                                        ]
                                    }
                                ]
                            },
                            "type": "If"
                        },
                        "For_each_-_URLs": {
                            "foreach": "@body('Entities_-_Get_URLs')?['URLs']",
                            "actions": {
                                "HTTP-RunNewURLAnalysis": {
                                    "type": "Http",
                                    "inputs": {
                                        "uri": "https://api.any.run/v1/analysis",
                                        "method": "POST",
                                        "headers": {
                                            "Authorization": "API-Key @{body('Get_secret_-_ANYRUN')?['value']}",
                                            "x-anyrun-connector": "@concat('MS_Sentinel:', variables('Connector Version'))"
                                        },
                                        "body": {
                                            "obj_type": "url",
                                            "obj_url": "@{item()?['Url']}",
                                            "opt_timeout": "120",
                                            "obj_ext_browser": "Microsoft Edge",
                                            "env_os": "windows",
                                            "env_bitness": "64",
                                            "env_version": "10",
                                            "opt_automated_interactivity": "true",
                                            "auto_confirm_uac": "true"
                                        }
                                    },
                                    "runtimeConfiguration": {
                                        "contentTransfer": {
                                            "transferMode": "Chunked"
                                        }
                                    }
                                },
                                "Parse_JSON_-_Get_URL_Detonation_UUID": {
                                    "runAfter": {
                                        "HTTP-RunNewURLAnalysis": [
                                            "Succeeded"
                                        ]
                                    },
                                    "type": "ParseJson",
                                    "inputs": {
                                        "content": "@body('HTTP-RunNewURLAnalysis')",
                                        "schema": {
                                            "type": "object",
                                            "properties": {
                                                "error": {
                                                    "type": "boolean"
                                                },
                                                "data": {
                                                    "type": "object",
                                                    "properties": {
                                                        "taskid": {
                                                            "type": "string"
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    }
                                },
                                "Set_-_URL_UUID": {
                                    "runAfter": {
                                        "Parse_JSON_-_Get_URL_Detonation_UUID": [
                                            "Succeeded"
                                        ]
                                    },
                                    "type": "SetVariable",
                                    "inputs": {
                                        "name": "UUID",
                                        "value": "@body('Parse_JSON_-_Get_URL_Detonation_UUID')?['data']?['taskid']"
                                    }
                                },
                                "Add_comment_to_incident_-_Analysis_Started_URL": {
                                    "runAfter": {
                                        "Set_-_URL_UUID": [
                                            "Succeeded"
                                        ]
                                    },
                                    "type": "ApiConnection",
                                    "inputs": {
                                        "host": {
                                            "connection": {
                                                "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                            }
                                        },
                                        "method": "post",
                                        "body": {
                                            "incidentArmId": "@triggerBody()?['object']?['id']",
                                            "message": "<p class=\"editor-paragraph\"><b><strong class=\"editor-text-bold\">ANY.RUN Sandbox Analysis Started:</strong></b><br>Analysis of the URL (@{item()?['Url']}) has been initiated in ANY.RUN Sandbox.</p><br><p class=\"editor-paragraph\"><b><strong class=\"editor-text-bold\">Link to interactive report:</strong></b> https://app.any.run/tasks/@{variables('UUID')}</p>"
                                        },
                                        "path": "/Incidents/Comment"
                                    }
                                },
                                "Delay_-_URL_Detonation_Result": {
                                    "runAfter": {
                                        "Add_comment_to_incident_-_Analysis_Started_URL": [
                                            "Succeeded"
                                        ]
                                    },
                                    "type": "Wait",
                                    "inputs": {
                                        "interval": {
                                            "count": 130,
                                            "unit": "Second"
                                        }
                                    }
                                },
                                "Until_URL_Analysis_is_not_completed": {
                                    "actions": {
                                        "HTTP-CheckURL-Result": {
                                            "type": "Http",
                                            "inputs": {
                                                "uri": "https://api.any.run/v1/analysis/monitor/@{variables('UUID')}",
                                                "method": "GET",
                                                "headers": {
                                                    "Authorization": "API-Key @{body('Get_secret_-_ANYRUN')?['value']}",
                                                    "x-anyrun-connector": "@concat('MS_Sentinel:', variables('Connector Version'))",
                                                    "Content-Type": "application/json"
                                                }
                                            },
                                            "runtimeConfiguration": {
                                                "contentTransfer": {
                                                    "transferMode": "Chunked"
                                                }
                                            }
                                        },
                                        "Parse_JSON_-_Task_Monitor_URL": {
                                            "runAfter": {
                                                "HTTP-CheckURL-Result": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "ParseJson",
                                            "inputs": {
                                                "content": "@trim(replace(body('HTTP-CheckURL-Result'), 'data:', ''))",
                                                "schema": {
                                                    "type": "object",
                                                    "properties": {
                                                        "task": {
                                                            "type": "object",
                                                            "properties": {
                                                                "scores": {
                                                                    "type": "object",
                                                                    "properties": {
                                                                        "verdict": {
                                                                            "type": "object",
                                                                            "properties": {
                                                                                "threat_level": {
                                                                                    "type": "integer"
                                                                                },
                                                                                "text": {
                                                                                    "type": "string"
                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        },
                                                        "completed": {
                                                            "type": "boolean"
                                                        },
                                                        "error": {
                                                            "type": "boolean"
                                                        }
                                                    }
                                                }
                                            }
                                        },
                                        "Delay_-_Time_added_to_Task_URL": {
                                            "runAfter": {
                                                "Parse_JSON_-_Task_Monitor_URL": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "Wait",
                                            "inputs": {
                                                "interval": {
                                                    "count": 60,
                                                    "unit": "Second"
                                                }
                                            }
                                        }
                                    },
                                    "runAfter": {
                                        "Delay_-_URL_Detonation_Result": [
                                            "Succeeded"
                                        ]
                                    },
                                    "expression": "@equals(body('Parse_JSON_-_Task_Monitor_URL')?['completed'], true)",
                                    "limit": {
                                        "count": 60,
                                        "timeout": "PT1H"
                                    },
                                    "type": "Until"
                                },
                                "Condition_-_Is_URL_Malicious": {
                                    "actions": {
                                        "HTTP-Full-JSON-Report_URL": {
                                            "type": "Http",
                                            "inputs": {
                                                "uri": "https://api.any.run/v1/analysis/@{variables('UUID')}",
                                                "method": "GET",
                                                "headers": {
                                                    "Authorization": "API-Key @{body('Get_secret_-_ANYRUN')?['value']}",
                                                    "x-anyrun-connector": "@concat('MS_Sentinel:', variables('Connector Version'))"
                                                }
                                            },
                                            "runtimeConfiguration": {
                                                "contentTransfer": {
                                                    "transferMode": "Chunked"
                                                }
                                            }
                                        },
                                        "Parse_JSON_-_ANYRUN_Report_URL": {
                                            "runAfter": {
                                                "HTTP-Full-JSON-Report_URL": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "ParseJson",
                                            "inputs": {
                                                "content": "@body('HTTP-Full-JSON-Report_URL')",
                                                "schema": {
                                                    "type": "object",
                                                    "properties": {
                                                        "error": {
                                                            "type": "boolean"
                                                        },
                                                        "data": {
                                                            "type": "object",
                                                            "properties": {
                                                                "analysis": {
                                                                    "type": "object",
                                                                    "properties": {
                                                                        "uuid": {
                                                                            "type": "string"
                                                                        },
                                                                        "permanentUrl": {
                                                                            "type": "string"
                                                                        },
                                                                        "reports": {
                                                                            "type": "object",
                                                                            "properties": {
                                                                                "IOC": {
                                                                                    "type": "string"
                                                                                },
                                                                                "MISP": {
                                                                                    "type": "string"
                                                                                },
                                                                                "HTML": {
                                                                                    "type": "string"
                                                                                },
                                                                                "STIX": {
                                                                                    "type": "string"
                                                                                },
                                                                                "graph": {
                                                                                    "type": "string"
                                                                                }
                                                                            }
                                                                        },
                                                                        "sandbox": {
                                                                            "type": "object",
                                                                            "properties": {
                                                                                "name": {
                                                                                    "type": "string"
                                                                                },
                                                                                "plan": {
                                                                                    "type": "object",
                                                                                    "properties": {
                                                                                        "name": {
                                                                                            "type": "string"
                                                                                        }
                                                                                    }
                                                                                }
                                                                            }
                                                                        },
                                                                        "duration": {
                                                                            "type": "integer"
                                                                        },
                                                                        "creation": {
                                                                            "type": "integer"
                                                                        },
                                                                        "creationText": {
                                                                            "type": "string"
                                                                        },
                                                                        "stopExec": {
                                                                            "type": "integer"
                                                                        },
                                                                        "stopExecText": {
                                                                            "type": "string"
                                                                        },
                                                                        "tags": {
                                                                            "type": "array",
                                                                            "items": {
                                                                                "type": "object",
                                                                                "properties": {
                                                                                    "users": {
                                                                                        "type": "boolean"
                                                                                    },
                                                                                    "tag": {
                                                                                        "type": "string"
                                                                                    }
                                                                                },
                                                                                "required": [
                                                                                    "users",
                                                                                    "tag"
                                                                                ]
                                                                            }
                                                                        },
                                                                        "options": {
                                                                            "type": "object",
                                                                            "properties": {
                                                                                "timeout": {
                                                                                    "type": "integer"
                                                                                },
                                                                                "additionalTime": {
                                                                                    "type": "integer"
                                                                                },
                                                                                "fakeNet": {
                                                                                    "type": "boolean"
                                                                                },
                                                                                "heavyEvasion": {
                                                                                    "type": "boolean"
                                                                                },
                                                                                "mitm": {
                                                                                    "type": "boolean"
                                                                                },
                                                                                "tor": {
                                                                                    "type": "object",
                                                                                    "properties": {
                                                                                        "used": {
                                                                                            "type": "boolean"
                                                                                        }
                                                                                    }
                                                                                },
                                                                                "presentation": {
                                                                                    "type": "boolean"
                                                                                },
                                                                                "video": {
                                                                                    "type": "boolean"
                                                                                },
                                                                                "hideSource": {
                                                                                    "type": "boolean"
                                                                                },
                                                                                "network": {
                                                                                    "type": "boolean"
                                                                                },
                                                                                "privacy": {
                                                                                    "type": "string"
                                                                                },
                                                                                "privateSample": {
                                                                                    "type": "boolean"
                                                                                },
                                                                                "automatization": {
                                                                                    "type": "object",
                                                                                    "properties": {
                                                                                        "uac": {
                                                                                            "type": "boolean"
                                                                                        },
                                                                                        "interactivity": {
                                                                                            "type": "boolean"
                                                                                        }
                                                                                    }
                                                                                }
                                                                            }
                                                                        },
                                                                        "scores": {
                                                                            "type": "object",
                                                                            "properties": {
                                                                                "verdict": {
                                                                                    "type": "object",
                                                                                    "properties": {
                                                                                        "score": {
                                                                                            "type": "integer"
                                                                                        },
                                                                                        "threatLevel": {
                                                                                            "type": "integer"
                                                                                        },
                                                                                        "threatLevelText": {
                                                                                            "type": "string"
                                                                                        }
                                                                                    }
                                                                                },
                                                                                "specs": {
                                                                                    "type": "object",
                                                                                    "properties": {
                                                                                        "autoStart": {
                                                                                            "type": "boolean"
                                                                                        },
                                                                                        "debugOutput": {
                                                                                            "type": "boolean"
                                                                                        },
                                                                                        "executableDropped": {
                                                                                            "type": "boolean"
                                                                                        },
                                                                                        "multiprocessing": {
                                                                                            "type": "boolean"
                                                                                        },
                                                                                        "serviceLauncher": {
                                                                                            "type": "boolean"
                                                                                        },
                                                                                        "stealing": {
                                                                                            "type": "boolean"
                                                                                        },
                                                                                        "privEscalation": {
                                                                                            "type": "boolean"
                                                                                        }
                                                                                    }
                                                                                }
                                                                            }
                                                                        },
                                                                        "content": {
                                                                            "type": "object",
                                                                            "properties": {
                                                                                "mainObject": {
                                                                                    "type": "object",
                                                                                    "properties": {
                                                                                        "type": {
                                                                                            "type": "string"
                                                                                        },
                                                                                        "permanentUrl": {
                                                                                            "type": "string"
                                                                                        },
                                                                                        "filename": {
                                                                                            "type": "string"
                                                                                        },
                                                                                        "basename": {
                                                                                            "type": "string"
                                                                                        },
                                                                                        "info": {
                                                                                            "type": "object",
                                                                                            "properties": {
                                                                                                "ext": {
                                                                                                    "type": "string"
                                                                                                },
                                                                                                "file": {
                                                                                                    "type": "string"
                                                                                                },
                                                                                                "mime": {
                                                                                                    "type": "string"
                                                                                                },
                                                                                                "trid": {
                                                                                                    "type": "array",
                                                                                                    "items": {
                                                                                                        "type": "object",
                                                                                                        "properties": {
                                                                                                            "procent": {
                                                                                                                "type": "integer"
                                                                                                            },
                                                                                                            "extension": {
                                                                                                                "type": "string"
                                                                                                            },
                                                                                                            "filetype": {
                                                                                                                "type": "string"
                                                                                                            }
                                                                                                        },
                                                                                                        "required": [
                                                                                                            "procent",
                                                                                                            "extension",
                                                                                                            "filetype"
                                                                                                        ]
                                                                                                    }
                                                                                                }
                                                                                            }
                                                                                        },
                                                                                        "hashes": {
                                                                                            "type": "object",
                                                                                            "properties": {
                                                                                                "md5": {
                                                                                                    "type": "string"
                                                                                                },
                                                                                                "sha1": {
                                                                                                    "type": "string"
                                                                                                },
                                                                                                "sha256": {
                                                                                                    "type": "string"
                                                                                                },
                                                                                                "ssdeep": {
                                                                                                    "type": "string"
                                                                                                }
                                                                                            }
                                                                                        }
                                                                                    }
                                                                                },
                                                                                "video": {
                                                                                    "type": "object",
                                                                                    "properties": {
                                                                                        "present": {
                                                                                            "type": "boolean"
                                                                                        },
                                                                                        "permanentUrl": {
                                                                                            "type": "string"
                                                                                        }
                                                                                    }
                                                                                },
                                                                                "pcap": {
                                                                                    "type": "object",
                                                                                    "properties": {
                                                                                        "present": {
                                                                                            "type": "boolean"
                                                                                        },
                                                                                        "permanentUrl": {
                                                                                            "type": "string"
                                                                                        }
                                                                                    }
                                                                                },
                                                                                "sslkeys": {
                                                                                    "type": "object",
                                                                                    "properties": {
                                                                                        "present": {
                                                                                            "type": "boolean"
                                                                                        }
                                                                                    }
                                                                                },
                                                                                "screenshots": {
                                                                                    "type": "array",
                                                                                    "items": {
                                                                                        "type": "object",
                                                                                        "properties": {
                                                                                            "uuid": {
                                                                                                "type": "string"
                                                                                            },
                                                                                            "time": {
                                                                                                "type": "integer"
                                                                                            },
                                                                                            "permanentUrl": {
                                                                                                "type": "string"
                                                                                            },
                                                                                            "thumbnailUrl": {
                                                                                                "type": "string"
                                                                                            }
                                                                                        },
                                                                                        "required": [
                                                                                            "uuid",
                                                                                            "time",
                                                                                            "permanentUrl",
                                                                                            "thumbnailUrl"
                                                                                        ]
                                                                                    }
                                                                                },
                                                                                "dumps": {
                                                                                    "type": "array",
                                                                                    "items": {
                                                                                        "type": "object",
                                                                                        "properties": {
                                                                                            "address": {
                                                                                                "type": "string"
                                                                                            },
                                                                                            "size": {
                                                                                                "type": "integer"
                                                                                            },
                                                                                            "pid": {
                                                                                                "type": "integer"
                                                                                            },
                                                                                            "processName": {
                                                                                                "type": "string"
                                                                                            },
                                                                                            "timestamp": {
                                                                                                "type": "integer"
                                                                                            },
                                                                                            "permanentUrl": {
                                                                                                "type": "string"
                                                                                            },
                                                                                            "fileNumber": {
                                                                                                "type": "integer"
                                                                                            },
                                                                                            "taskUUID": {
                                                                                                "type": "string"
                                                                                            }
                                                                                        },
                                                                                        "required": [
                                                                                            "address",
                                                                                            "size",
                                                                                            "pid",
                                                                                            "processName",
                                                                                            "timestamp",
                                                                                            "permanentUrl",
                                                                                            "fileNumber",
                                                                                            "taskUUID"
                                                                                        ]
                                                                                    }
                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                },
                                                                "environments": {
                                                                    "type": "object",
                                                                    "properties": {
                                                                        "os": {
                                                                            "type": "object",
                                                                            "properties": {
                                                                                "title": {
                                                                                    "type": "string"
                                                                                },
                                                                                "build": {
                                                                                    "type": "integer"
                                                                                },
                                                                                "product": {
                                                                                    "type": "string"
                                                                                },
                                                                                "variant": {
                                                                                    "type": "string"
                                                                                },
                                                                                "productType": {
                                                                                    "type": "string"
                                                                                },
                                                                                "major": {
                                                                                    "type": "string"
                                                                                },
                                                                                "servicePack": {},
                                                                                "softSet": {
                                                                                    "type": "string"
                                                                                },
                                                                                "bitness": {
                                                                                    "type": "integer"
                                                                                }
                                                                            }
                                                                        },
                                                                        "internetExplorer": {
                                                                            "type": "object",
                                                                            "properties": {
                                                                                "version": {
                                                                                    "type": "string"
                                                                                },
                                                                                "kbnum": {
                                                                                    "type": "string"
                                                                                }
                                                                            }
                                                                        },
                                                                        "software": {
                                                                            "type": "array",
                                                                            "items": {
                                                                                "type": "object",
                                                                                "properties": {
                                                                                    "title": {
                                                                                        "type": "string"
                                                                                    },
                                                                                    "version": {
                                                                                        "type": "string"
                                                                                    }
                                                                                },
                                                                                "required": [
                                                                                    "title",
                                                                                    "version"
                                                                                ]
                                                                            }
                                                                        },
                                                                        "hotfixes": {
                                                                            "type": "array",
                                                                            "items": {
                                                                                "type": "object",
                                                                                "properties": {
                                                                                    "title": {
                                                                                        "type": "string"
                                                                                    }
                                                                                },
                                                                                "required": [
                                                                                    "title"
                                                                                ]
                                                                            }
                                                                        }
                                                                    }
                                                                },
                                                                "counters": {
                                                                    "type": "object",
                                                                    "properties": {
                                                                        "processes": {
                                                                            "type": "object",
                                                                            "properties": {
                                                                                "total": {
                                                                                    "type": "integer"
                                                                                },
                                                                                "monitored": {
                                                                                    "type": "integer"
                                                                                },
                                                                                "suspicious": {
                                                                                    "type": "integer"
                                                                                },
                                                                                "malicious": {
                                                                                    "type": "integer"
                                                                                }
                                                                            }
                                                                        },
                                                                        "network": {
                                                                            "type": "object",
                                                                            "properties": {
                                                                                "http": {
                                                                                    "type": "integer"
                                                                                },
                                                                                "connections": {
                                                                                    "type": "integer"
                                                                                },
                                                                                "dns": {
                                                                                    "type": "integer"
                                                                                },
                                                                                "threats": {
                                                                                    "type": "integer"
                                                                                }
                                                                            }
                                                                        },
                                                                        "files": {
                                                                            "type": "object",
                                                                            "properties": {
                                                                                "unknown": {
                                                                                    "type": "integer"
                                                                                },
                                                                                "text": {
                                                                                    "type": "integer"
                                                                                },
                                                                                "suspicious": {
                                                                                    "type": "integer"
                                                                                },
                                                                                "malicious": {
                                                                                    "type": "integer"
                                                                                }
                                                                            }
                                                                        },
                                                                        "registry": {
                                                                            "type": "object",
                                                                            "properties": {
                                                                                "total": {
                                                                                    "type": "integer"
                                                                                },
                                                                                "read": {
                                                                                    "type": "integer"
                                                                                },
                                                                                "write": {
                                                                                    "type": "integer"
                                                                                },
                                                                                "delete": {
                                                                                    "type": "integer"
                                                                                }
                                                                            }
                                                                        },
                                                                        "synchronization": {
                                                                            "type": "object",
                                                                            "properties": {
                                                                                "total": {
                                                                                    "type": "integer"
                                                                                },
                                                                                "operation": {
                                                                                    "type": "object",
                                                                                    "properties": {
                                                                                        "open": {
                                                                                            "type": "integer"
                                                                                        },
                                                                                        "create": {
                                                                                            "type": "integer"
                                                                                        }
                                                                                    }
                                                                                },
                                                                                "type": {
                                                                                    "type": "object",
                                                                                    "properties": {
                                                                                        "mutex": {
                                                                                            "type": "integer"
                                                                                        },
                                                                                        "event": {
                                                                                            "type": "integer"
                                                                                        }
                                                                                    }
                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                },
                                                                "malconf": {
                                                                    "type": "array"
                                                                },
                                                                "mitre": {
                                                                    "type": "array"
                                                                },
                                                                "status": {
                                                                    "type": "string"
                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                        },
                                        "Select_Tags_URL": {
                                            "runAfter": {
                                                "Parse_JSON_-_ANYRUN_Report_URL": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "Select",
                                            "inputs": {
                                                "from": "@body('Parse_JSON_-_ANYRUN_Report_URL')?['data']?['analysis']?['tags']",
                                                "select": "@item()['tag']"
                                            }
                                        },
                                        "For_each_-_Add_Tags_URL": {
                                            "foreach": "@outputs('Compose_-_All_Tags_URL')",
                                            "actions": {
                                                "Update_incident_-_Add_Tags_URL": {
                                                    "type": "ApiConnection",
                                                    "inputs": {
                                                        "host": {
                                                            "connection": {
                                                                "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                                            }
                                                        },
                                                        "method": "put",
                                                        "body": {
                                                            "incidentArmId": "@triggerBody()?['object']?['id']",
                                                            "tagsToAdd": {
                                                                "TagsToAdd": [
                                                                    {
                                                                        "Tag": "@{items('For_each_-_Add_Tags_URL')}"
                                                                    }
                                                                ]
                                                            }
                                                        },
                                                        "path": "/Incidents"
                                                    }
                                                }
                                            },
                                            "runAfter": {
                                                "Compose_-_All_Tags_URL": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "Foreach"
                                        },
                                        "Compose_-_All_Tags_URL": {
                                            "runAfter": {
                                                "Select_Tags_URL": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "Compose",
                                            "inputs": "@union(body('Select_Tags_URL'), createArray('ANY.RUN'))"
                                        },
                                        "HTTP-GetIOC_URL": {
                                            "runAfter": {
                                                "For_each_-_Add_Tags_URL": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "Http",
                                            "inputs": {
                                                "uri": "https://api.any.run/report/@{variables('UUID')}/ioc/json",
                                                "method": "GET",
                                                "headers": {
                                                    "Authorization": "API-Key @{body('Get_secret_-_ANYRUN')?['value']}",
                                                    "x-anyrun-connector": "@concat('MS_Sentinel:', variables('Connector Version'))"
                                                }
                                            },
                                            "runtimeConfiguration": {
                                                "contentTransfer": {
                                                    "transferMode": "Chunked"
                                                }
                                            }
                                        },
                                        "Parse_JSON_-_IOC_URL": {
                                            "runAfter": {
                                                "HTTP-GetIOC_URL": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "ParseJson",
                                            "inputs": {
                                                "content": "@body('HTTP-GetIOC_URL')",
                                                "schema": {
                                                    "type": "array",
                                                    "items": {
                                                        "type": "object",
                                                        "properties": {
                                                            "category": {
                                                                "type": "string"
                                                            },
                                                            "type": {
                                                                "type": "string"
                                                            },
                                                            "name": {
                                                                "type": "string"
                                                            },
                                                            "ioc": {
                                                                "type": "string"
                                                            },
                                                            "reputation": {
                                                                "type": "integer"
                                                            },
                                                            "discoveringEntryId": {
                                                                "type": "string"
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                        },
                                        "Transform_IOC_Reputation_URL": {
                                            "runAfter": {
                                                "Parse_JSON_-_IOC_URL": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "Select",
                                            "inputs": {
                                                "from": "@body('Parse_JSON_-_IOC_URL')",
                                                "select": {
                                                    "ioc": "@item()['ioc']",
                                                    "type": "@item()['type']",
                                                    "severity": "@if(equals(item()['reputation'], 0), 'Low', if(equals(item()['reputation'], 1), 'Suspicious', if(equals(item()['reputation'], 2), 'Malicious', 'Low')))"
                                                }
                                            }
                                        },
                                        "Filter_Malicious_IOCs_URL": {
                                            "runAfter": {
                                                "Transform_IOC_Reputation_URL": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "Query",
                                            "inputs": {
                                                "from": "@body('Transform_IOC_Reputation_URL')",
                                                "where": "@equals(item()['severity'], 'Malicious')"
                                            }
                                        },
                                        "Filter_Suspicious_IOCs_URL": {
                                            "runAfter": {
                                                "Transform_IOC_Reputation_URL": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "Query",
                                            "inputs": {
                                                "from": "@body('Transform_IOC_Reputation_URL')",
                                                "where": "@equals(item()['severity'], 'Suspicious')"
                                            }
                                        },
                                        "Filter_Unknown_IOCs_URL": {
                                            "runAfter": {
                                                "Transform_IOC_Reputation_URL": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "Query",
                                            "inputs": {
                                                "from": "@body('Transform_IOC_Reputation_URL')",
                                                "where": "@equals(item()['severity'], 'Low')"
                                            }
                                        },
                                        "Condition_-_Malicious_IOCs_is_null_URL": {
                                            "actions": {
                                                "Filter_Malicious_IOCs_-_ip_URL": {
                                                    "type": "Query",
                                                    "inputs": {
                                                        "from": "@body('Filter_Malicious_IOCs_URL')",
                                                        "where": "@equals(item()['type'], 'ip')"
                                                    }
                                                },
                                                "Filter_Malicious_IOCs_-_domain_URL": {
                                                    "type": "Query",
                                                    "inputs": {
                                                        "from": "@body('Filter_Malicious_IOCs_URL')",
                                                        "where": "@equals(item()['type'], 'domain')"
                                                    }
                                                },
                                                "Filter_Malicious_IOCs_-_URL_URL": {
                                                    "type": "Query",
                                                    "inputs": {
                                                        "from": "@body('Filter_Malicious_IOCs_URL')",
                                                        "where": "@equals(item()['type'], 'url')"
                                                    }
                                                },
                                                "Filter_Malicious_IOCs_-_hash_URL": {
                                                    "type": "Query",
                                                    "inputs": {
                                                        "from": "@body('Filter_Malicious_IOCs_URL')",
                                                        "where": "@equals(item()['type'], 'sha256')"
                                                    }
                                                },
                                                "Select_Malicious_IOCs_-_hash_URL": {
                                                    "runAfter": {
                                                        "Filter_Malicious_IOCs_-_hash_URL": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "Select",
                                                    "inputs": {
                                                        "from": "@body('Filter_Malicious_IOCs_-_hash_URL')",
                                                        "select": "@item()?['ioc']"
                                                    }
                                                },
                                                "Transform_Malicious_IOCs_to_STIX_-_hash_URL": {
                                                    "runAfter": {
                                                        "Select_Malicious_IOCs_-_hash_URL": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "Select",
                                                    "inputs": {
                                                        "from": "@body('Select_Malicious_IOCs_-_hash_URL')",
                                                        "select": {
                                                            "type": "indicator",
                                                            "spec_version": 2.1,
                                                            "id": "@concat('indicator--', guid())",
                                                            "created": "@utcNow('yyyy-MM-ddTHH:mm:ssZ')",
                                                            "modified": "@utcNow('yyyy-MM-ddTHH:mm:ssZ')",
                                                            "pattern": "@concat('[file:hashes.''SHA-256'' = ''', item(), ''']')",
                                                            "pattern_type": "stix",
                                                            "valid_from": "@utcNow('yyyy-MM-ddTHH:mm:ssZ')",
                                                            "valid_until": "@addDays(utcNow(), 365, 'yyyy-MM-ddTHH:mm:ssZ')",
                                                            "description": "https://app.any.run/tasks/",
                                                            "confidence": 100
                                                        }
                                                    }
                                                },
                                                "Compose_-_STIX_objects_of_Malicious_IOCs_to_TI_URL": {
                                                    "runAfter": {
                                                        "Transform_Malicious_IOCs_to_STIX_-_hash_URL": [
                                                            "Succeeded"
                                                        ],
                                                        "Transform_Malicious_IOCs_to_STIX_-_ip_URL": [
                                                            "Succeeded"
                                                        ],
                                                        "Transform_Malicious_IOCs_to_STIX_-_domain_URL": [
                                                            "Succeeded"
                                                        ],
                                                        "Transform_Malicious_IOCs_to_STIX_-_URL_URL": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "Compose",
                                                    "inputs": "@union(if(greater(length(body('Transform_Malicious_IOCs_to_STIX_-_hash_URL')), 0), body('Transform_Malicious_IOCs_to_STIX_-_hash_URL'), json('[]')), if(greater(length(body('Transform_Malicious_IOCs_to_STIX_-_ip_URL')), 0), body('Transform_Malicious_IOCs_to_STIX_-_ip_URL'), json('[]')), if(greater(length(body('Transform_Malicious_IOCs_to_STIX_-_domain_URL')), 0), body('Transform_Malicious_IOCs_to_STIX_-_domain_URL'), json('[]')), if(greater(length(body('Transform_Malicious_IOCs_to_STIX_-_URL_URL')), 0), body('Transform_Malicious_IOCs_to_STIX_-_URL_URL'), json('[]')))"
                                                },
                                                "Select_Malicious_IOCs_-_ip_URL": {
                                                    "runAfter": {
                                                        "Filter_Malicious_IOCs_-_ip_URL": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "Select",
                                                    "inputs": {
                                                        "from": "@body('Filter_Malicious_IOCs_-_ip_URL')",
                                                        "select": "@item()?['ioc']"
                                                    }
                                                },
                                                "Transform_Malicious_IOCs_to_STIX_-_ip_URL": {
                                                    "runAfter": {
                                                        "Select_Malicious_IOCs_-_ip_URL": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "Select",
                                                    "inputs": {
                                                        "from": "@body('Select_Malicious_IOCs_-_ip_URL')",
                                                        "select": {
                                                            "type": "indicator",
                                                            "spec_version": 2.1,
                                                            "id": "@concat('indicator--', guid())",
                                                            "created": "@utcNow('yyyy-MM-ddTHH:mm:ssZ')",
                                                            "modified": "@utcNow('yyyy-MM-ddTHH:mm:ssZ')",
                                                            "pattern": "@concat('[ipv4-addr:value = ''', item(), ''']')",
                                                            "pattern_type": "stix",
                                                            "valid_from": "@utcNow('yyyy-MM-ddTHH:mm:ssZ')",
                                                            "valid_until": "@addDays(utcNow(), 365, 'yyyy-MM-ddTHH:mm:ssZ')",
                                                            "description": "https://app.any.run/tasks/",
                                                            "confidence": 100
                                                        }
                                                    }
                                                },
                                                "Select_Malicious_IOCs_-_domain_URL": {
                                                    "runAfter": {
                                                        "Filter_Malicious_IOCs_-_domain_URL": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "Select",
                                                    "inputs": {
                                                        "from": "@body('Filter_Malicious_IOCs_-_domain_URL')",
                                                        "select": "@item()?['ioc']"
                                                    }
                                                },
                                                "Transform_Malicious_IOCs_to_STIX_-_domain_URL": {
                                                    "runAfter": {
                                                        "Select_Malicious_IOCs_-_domain_URL": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "Select",
                                                    "inputs": {
                                                        "from": "@body('Select_Malicious_IOCs_-_domain_URL')",
                                                        "select": {
                                                            "type": "indicator",
                                                            "spec_version": 2.1,
                                                            "id": "@concat('indicator--', guid())",
                                                            "created": "@utcNow('yyyy-MM-ddTHH:mm:ssZ')",
                                                            "modified": "@utcNow('yyyy-MM-ddTHH:mm:ssZ')",
                                                            "pattern": "@concat('[domain-name:value = ''', item(), ''']')",
                                                            "pattern_type": "stix",
                                                            "valid_from": "@utcNow('yyyy-MM-ddTHH:mm:ssZ')",
                                                            "valid_until": "@addDays(utcNow(), 365, 'yyyy-MM-ddTHH:mm:ssZ')",
                                                            "description": "https://app.any.run/tasks/",
                                                            "confidence": 100
                                                        }
                                                    }
                                                },
                                                "Select_Malicious_IOCs_-_URL_URL": {
                                                    "runAfter": {
                                                        "Filter_Malicious_IOCs_-_URL_URL": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "Select",
                                                    "inputs": {
                                                        "from": "@body('Filter_Malicious_IOCs_-_URL_URL')",
                                                        "select": "@item()?['ioc']"
                                                    }
                                                },
                                                "Transform_Malicious_IOCs_to_STIX_-_URL_URL": {
                                                    "runAfter": {
                                                        "Select_Malicious_IOCs_-_URL_URL": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "Select",
                                                    "inputs": {
                                                        "from": "@body('Select_Malicious_IOCs_-_URL_URL')",
                                                        "select": {
                                                            "type": "indicator",
                                                            "spec_version": 2.1,
                                                            "id": "@concat('indicator--', guid())",
                                                            "created": "@utcNow('yyyy-MM-ddTHH:mm:ssZ')",
                                                            "modified": "@utcNow('yyyy-MM-ddTHH:mm:ssZ')",
                                                            "pattern": "@concat('[url:value = ''', item(), ''']')",
                                                            "pattern_type": "stix",
                                                            "valid_from": "@utcNow('yyyy-MM-ddTHH:mm:ssZ')",
                                                            "valid_until": "@addDays(utcNow(), 365, 'yyyy-MM-ddTHH:mm:ssZ')",
                                                            "description": "https://app.any.run/tasks/",
                                                            "confidence": 100
                                                        }
                                                    }
                                                },
                                                "Select_-_Chunk_Malicious_IOCs_array_URL": {
                                                    "runAfter": {
                                                        "Compose_-_STIX_objects_of_Malicious_IOCs_to_TI_URL": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "Select",
                                                    "inputs": {
                                                        "from": "@range(0, add(div(length(outputs('Compose_-_STIX_objects_of_Malicious_IOCs_to_TI_URL')), 99), if(equals(mod(length(outputs('Compose_-_STIX_objects_of_Malicious_IOCs_to_TI_URL')), 99), 0), 0, 1)))",
                                                        "select": "@take(skip(outputs('Compose_-_STIX_objects_of_Malicious_IOCs_to_TI_URL'), mul(item(), 99)), 99)"
                                                    }
                                                },
                                                "For_each_-_Upload_Malicious_IOCs_URL": {
                                                    "foreach": "@outputs('Select_-_Chunk_Malicious_IOCs_array_URL')['body']",
                                                    "actions": {
                                                        "Threat_Intelligence_-_Upload_Indicators_of_Compromise_(V2)_-_Malicious_IOCs_URL": {
                                                            "type": "ApiConnection",
                                                            "inputs": {
                                                                "host": {
                                                                    "connection": {
                                                                        "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                                                    }
                                                                },
                                                                "method": "post",
                                                                "body": {
                                                                    "sourcesystem": "ANY.RUN-Sandbox",
                                                                    "indicators": "@item()"
                                                                },
                                                                "path": "/V2/ThreatIntelligence/@{encodeURIComponent(triggerBody()?['workspaceId'])}/UploadIndicators/"
                                                            }
                                                        }
                                                    },
                                                    "runAfter": {
                                                        "Select_-_Chunk_Malicious_IOCs_array_URL": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "Foreach"
                                                }
                                            },
                                            "runAfter": {
                                                "Filter_Malicious_IOCs_URL": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "else": {
                                                "actions": {}
                                            },
                                            "expression": {
                                                "and": [
                                                    {
                                                        "equals": [
                                                            "@empty(body('Filter_Malicious_IOCs_URL'))",
                                                            false
                                                        ]
                                                    }
                                                ]
                                            },
                                            "type": "If"
                                        },
                                        "Condition_-_Suspicious_IOCs_is_null_URL": {
                                            "actions": {
                                                "Filter_Suspicious_IOCs_-_ip_URL": {
                                                    "type": "Query",
                                                    "inputs": {
                                                        "from": "@body('Filter_Suspicious_IOCs_URL')",
                                                        "where": "@equals(item()['type'], 'ip')"
                                                    }
                                                },
                                                "Filter_Suspicious_IOCs_-_domain_URL": {
                                                    "type": "Query",
                                                    "inputs": {
                                                        "from": "@body('Filter_Suspicious_IOCs_URL')",
                                                        "where": "@equals(item()['type'], 'domain')"
                                                    }
                                                },
                                                "Filter_Suspicious_IOCs_-_URL_URL": {
                                                    "type": "Query",
                                                    "inputs": {
                                                        "from": "@body('Filter_Suspicious_IOCs_URL')",
                                                        "where": "@equals(item()['type'], 'url')"
                                                    }
                                                },
                                                "Filter_Suspicious_IOCs_-_hash_URL": {
                                                    "type": "Query",
                                                    "inputs": {
                                                        "from": "@body('Filter_Suspicious_IOCs_URL')",
                                                        "where": "@equals(item()['type'], 'sha256')"
                                                    }
                                                },
                                                "Select_Suspicious_IOCs_-_hash_URL": {
                                                    "runAfter": {
                                                        "Filter_Suspicious_IOCs_-_hash_URL": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "Select",
                                                    "inputs": {
                                                        "from": "@body('Filter_Suspicious_IOCs_-_hash_URL')",
                                                        "select": "@item()?['ioc']"
                                                    }
                                                },
                                                "Transform_Suspicious_IOCs_to_STIX_-_hash_URL": {
                                                    "runAfter": {
                                                        "Select_Suspicious_IOCs_-_hash_URL": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "Select",
                                                    "inputs": {
                                                        "from": "@body('Select_Suspicious_IOCs_-_hash_URL')",
                                                        "select": {
                                                            "type": "indicator",
                                                            "spec_version": 2.1,
                                                            "id": "@concat('indicator--', guid())",
                                                            "created": "@utcNow('yyyy-MM-ddTHH:mm:ssZ')",
                                                            "modified": "@utcNow('yyyy-MM-ddTHH:mm:ssZ')",
                                                            "pattern": "@concat('[file:hashes.''SHA-256'' = ''', item(), ''']')",
                                                            "pattern_type": "stix",
                                                            "valid_from": "@utcNow('yyyy-MM-ddTHH:mm:ssZ')",
                                                            "valid_until": "@addDays(utcNow(), 365, 'yyyy-MM-ddTHH:mm:ssZ')",
                                                            "description": "https://app.any.run/tasks/",
                                                            "confidence": 50
                                                        }
                                                    }
                                                },
                                                "Compose_-_STIX_objects_of_Suspicious_IOCs_to_TI_URL": {
                                                    "runAfter": {
                                                        "Transform_Suspicious_IOCs_to_STIX_-_hash_URL": [
                                                            "Succeeded"
                                                        ],
                                                        "Transform_Suspicious_IOCs_to_STIX_-_ip_URL": [
                                                            "Succeeded"
                                                        ],
                                                        "Transform_Suspicious_IOCs_to_STIX_-_domain_URL": [
                                                            "Succeeded"
                                                        ],
                                                        "Transform_Suspicious_IOCs_to_STIX_-_URL_URL": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "Compose",
                                                    "inputs": "@union(if(greater(length(body('Transform_Suspicious_IOCs_to_STIX_-_hash_URL')), 0), body('Transform_Suspicious_IOCs_to_STIX_-_hash_URL'), json('[]')), if(greater(length(body('Transform_Suspicious_IOCs_to_STIX_-_ip_URL')), 0), body('Transform_Suspicious_IOCs_to_STIX_-_ip_URL'), json('[]')), if(greater(length(body('Transform_Suspicious_IOCs_to_STIX_-_domain_URL')), 0), body('Transform_Suspicious_IOCs_to_STIX_-_domain_URL'), json('[]')), if(greater(length(body('Transform_Suspicious_IOCs_to_STIX_-_URL_URL')), 0), body('Transform_Suspicious_IOCs_to_STIX_-_URL_URL'), json('[]')))"
                                                },
                                                "Select_Suspicious_IOCs_-_ip_URL": {
                                                    "runAfter": {
                                                        "Filter_Suspicious_IOCs_-_ip_URL": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "Select",
                                                    "inputs": {
                                                        "from": "@body('Filter_Suspicious_IOCs_-_ip_URL')",
                                                        "select": "@item()?['ioc']"
                                                    }
                                                },
                                                "Transform_Suspicious_IOCs_to_STIX_-_ip_URL": {
                                                    "runAfter": {
                                                        "Select_Suspicious_IOCs_-_ip_URL": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "Select",
                                                    "inputs": {
                                                        "from": "@body('Select_Suspicious_IOCs_-_ip_URL')",
                                                        "select": {
                                                            "type": "indicator",
                                                            "spec_version": 2.1,
                                                            "id": "@concat('indicator--', guid())",
                                                            "created": "@utcNow('yyyy-MM-ddTHH:mm:ssZ')",
                                                            "modified": "@utcNow('yyyy-MM-ddTHH:mm:ssZ')",
                                                            "pattern": "@concat('[ipv4-addr:value = ''', item(), ''']')",
                                                            "pattern_type": "stix",
                                                            "valid_from": "@utcNow('yyyy-MM-ddTHH:mm:ssZ')",
                                                            "valid_until": "@addDays(utcNow(), 365, 'yyyy-MM-ddTHH:mm:ssZ')",
                                                            "description": "https://app.any.run/tasks/",
                                                            "confidence": 100
                                                        }
                                                    }
                                                },
                                                "Select_Suspicious_IOCs_-_domain_URL": {
                                                    "runAfter": {
                                                        "Filter_Suspicious_IOCs_-_domain_URL": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "Select",
                                                    "inputs": {
                                                        "from": "@body('Filter_Suspicious_IOCs_-_domain_URL')",
                                                        "select": "@item()?['ioc']"
                                                    }
                                                },
                                                "Transform_Suspicious_IOCs_to_STIX_-_domain_URL": {
                                                    "runAfter": {
                                                        "Select_Suspicious_IOCs_-_domain_URL": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "Select",
                                                    "inputs": {
                                                        "from": "@body('Select_Suspicious_IOCs_-_domain_URL')",
                                                        "select": {
                                                            "type": "indicator",
                                                            "spec_version": 2.1,
                                                            "id": "@concat('indicator--', guid())",
                                                            "created": "@utcNow('yyyy-MM-ddTHH:mm:ssZ')",
                                                            "modified": "@utcNow('yyyy-MM-ddTHH:mm:ssZ')",
                                                            "pattern": "@concat('[domain-name:value = ''', item(), ''']')",
                                                            "pattern_type": "stix",
                                                            "valid_from": "@utcNow('yyyy-MM-ddTHH:mm:ssZ')",
                                                            "valid_until": "@addDays(utcNow(), 365, 'yyyy-MM-ddTHH:mm:ssZ')",
                                                            "description": "https://app.any.run/tasks/",
                                                            "confidence": 100
                                                        }
                                                    }
                                                },
                                                "Select_Suspicious_IOCs_-_URL_URL": {
                                                    "runAfter": {
                                                        "Filter_Suspicious_IOCs_-_URL_URL": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "Select",
                                                    "inputs": {
                                                        "from": "@body('Filter_Suspicious_IOCs_-_URL_URL')",
                                                        "select": "@item()?['ioc']"
                                                    }
                                                },
                                                "Transform_Suspicious_IOCs_to_STIX_-_URL_URL": {
                                                    "runAfter": {
                                                        "Select_Suspicious_IOCs_-_URL_URL": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "Select",
                                                    "inputs": {
                                                        "from": "@body('Select_Suspicious_IOCs_-_URL_URL')",
                                                        "select": {
                                                            "type": "indicator",
                                                            "spec_version": 2.1,
                                                            "id": "@concat('indicator--', guid())",
                                                            "created": "@utcNow('yyyy-MM-ddTHH:mm:ssZ')",
                                                            "modified": "@utcNow('yyyy-MM-ddTHH:mm:ssZ')",
                                                            "pattern": "@concat('[url:value = ''', item(), ''']')",
                                                            "pattern_type": "stix",
                                                            "valid_from": "@utcNow('yyyy-MM-ddTHH:mm:ssZ')",
                                                            "valid_until": "@addDays(utcNow(), 365, 'yyyy-MM-ddTHH:mm:ssZ')",
                                                            "description": "https://app.any.run/tasks/",
                                                            "confidence": 50
                                                        }
                                                    }
                                                },
                                                "Select_-_Chunk_Suspicious_IOCs_array_URL": {
                                                    "runAfter": {
                                                        "Compose_-_STIX_objects_of_Suspicious_IOCs_to_TI_URL": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "Select",
                                                    "inputs": {
                                                        "from": "@range(0, add(div(length(outputs('Compose_-_STIX_objects_of_Suspicious_IOCs_to_TI_URL')), 99), if(equals(mod(length(outputs('Compose_-_STIX_objects_of_Suspicious_IOCs_to_TI_URL')), 99), 0), 0, 1)))",
                                                        "select": "@take(skip(outputs('Compose_-_STIX_objects_of_Suspicious_IOCs_to_TI_URL'), mul(item(), 99)), 99)"
                                                    }
                                                },
                                                "For_each_-_Upload_Suspicious_IOCs_URL": {
                                                    "foreach": "@outputs('Select_-_Chunk_Suspicious_IOCs_array_URL')['body']",
                                                    "actions": {
                                                        "Threat_Intelligence_-_Upload_Indicators_of_Compromise_(V2)_-_Suspicious_IOCs_URL": {
                                                            "type": "ApiConnection",
                                                            "inputs": {
                                                                "host": {
                                                                    "connection": {
                                                                        "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                                                    }
                                                                },
                                                                "method": "post",
                                                                "body": {
                                                                    "sourcesystem": "ANY.RUN-Sandbox",
                                                                    "indicators": "@item()"
                                                                },
                                                                "path": "/V2/ThreatIntelligence/@{encodeURIComponent(triggerBody()?['workspaceId'])}/UploadIndicators/"
                                                            }
                                                        }
                                                    },
                                                    "runAfter": {
                                                        "Select_-_Chunk_Suspicious_IOCs_array_URL": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "Foreach"
                                                }
                                            },
                                            "runAfter": {
                                                "Filter_Suspicious_IOCs_URL": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "else": {
                                                "actions": {}
                                            },
                                            "expression": {
                                                "and": [
                                                    {
                                                        "equals": [
                                                            "@empty(body('Filter_Suspicious_IOCs_URL'))",
                                                            false
                                                        ]
                                                    }
                                                ]
                                            },
                                            "type": "If"
                                        },
                                        "Compose_Sorted_IOCs_URL": {
                                            "runAfter": {
                                                "Condition_-_Suspicious_IOCs_is_null_URL": [
                                                    "Succeeded"
                                                ],
                                                "Condition_-_Malicious_IOCs_is_null_URL": [
                                                    "Succeeded"
                                                ],
                                                "Filter_Unknown_IOCs_URL": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "Compose",
                                            "inputs": "@union(body('Filter_Malicious_IOCs_URL'), body('Filter_Suspicious_IOCs_URL'), body('Filter_Unknown_IOCs_URL'))"
                                        },
                                        "Create_IOC_Table_Rows_URL": {
                                            "runAfter": {
                                                "Compose_Sorted_IOCs_URL": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "Select",
                                            "inputs": {
                                                "from": "@outputs('Compose_Sorted_IOCs_URL')",
                                                "select": "<tr><td>@{item()['ioc']}</td><td>@{item()['type']}</td><td>@{item()['severity']}</td></tr>"
                                            }
                                        },
                                        "Compose_IOC_Table_URL": {
                                            "runAfter": {
                                                "Create_IOC_Table_Rows_URL": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "Compose",
                                            "inputs": "<table border='1'><tr><th>IOC</th><th>Type</th><th>Severity</th></tr>@{join(body('Create_IOC_Table_Rows_URL'), '')}</table>"
                                        },
                                        "Add_comment_to_incident_(V3)_-_ANY.RUN_Output_-_URL": {
                                            "runAfter": {
                                                "Compose_IOC_Table_URL": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "ApiConnection",
                                            "inputs": {
                                                "host": {
                                                    "connection": {
                                                        "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                                    }
                                                },
                                                "method": "post",
                                                "body": {
                                                    "incidentArmId": "@triggerBody()?['object']?['id']",
                                                    "message": "<p class=\"editor-paragraph\"><b><strong class=\"editor-text-bold\">ANY.RUN URL Detonation Results:</strong></b><br><span style=\"color: rgb(208, 2, 27);\">A malicious URL has been detected during ANY.RUN Sandbox analysis</span> (@{replace(replace(item()?['Url'], '.', '[.]'), 'https://', '')}).</p><br><p class=\"editor-paragraph\"><b><strong class=\"editor-text-bold\">Verdict:</strong></b> @{body('Parse_JSON_-_Task_Monitor_URL')?['task']?['scores']?['verdict']?['text']}<br><b><strong class=\"editor-text-bold\">Threat score:</strong></b> @{body('Parse_JSON_-_ANYRUN_Report_URL')?['data']?['analysis']?['scores']?['verdict']?['score']}/100<br><b><strong class=\"editor-text-bold\">Link to interactive report</strong></b> - https://app.any.run/tasks/</p><br><p class=\"editor-paragraph\"><b><strong class=\"editor-text-bold\">Detected IOCs:</strong></b><br>@{outputs('Compose_IOC_Table_URL')}</p>"
                                                },
                                                "path": "/Incidents/Comment"
                                            }
                                        }
                                    },
                                    "runAfter": {
                                        "Until_URL_Analysis_is_not_completed": [
                                            "Succeeded"
                                        ]
                                    },
                                    "else": {
                                        "actions": {
                                            "Add_comment_to_incident_(V3)_-_Clean_Scan_URL_ANY.RUN_Output": {
                                                "type": "ApiConnection",
                                                "inputs": {
                                                    "host": {
                                                        "connection": {
                                                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                                        }
                                                    },
                                                    "method": "post",
                                                    "body": {
                                                        "incidentArmId": "@{triggerBody()?['object']?['id']}",
                                                        "message": "<p class=\"editor-paragraph\"><b><strong class=\"editor-text-bold\">ANY.RUN URL Detonation Results:</strong></b><br><span style=\"color: rgb(65, 117, 5);\">URL is clean and is no malicious activity was found during detonation via ANY.RUN Sandbox </span>(@{replace(replace(replace(item()?['Url'], '.', '[.]'), 'https://', ''), 'http://', '')}).</p><br><p class=\"editor-paragraph\"><b><strong class=\"editor-text-bold\">Link to interactive report</strong></b> - https://app.any.run/tasks/@{variables('UUID')}</p>"
                                                    },
                                                    "path": "/Incidents/Comment"
                                                }
                                            }
                                        }
                                    },
                                    "expression": {
                                        "or": [
                                            {
                                                "greater": [
                                                    "@body('Parse_JSON_-_Task_Monitor_URL')?['task']?['scores']?['verdict']?['threat_level']",
                                                    0
                                                ]
                                            },
                                            {
                                                "not": {
                                                    "equals": [
                                                        "@body('Parse_JSON_-_Task_Monitor_URL')?['task']?['scores']?['verdict']?['threat_level']",
                                                        "No threats detected"
                                                    ]
                                                }
                                            }
                                        ]
                                    },
                                    "type": "If"
                                }
                            },
                            "runAfter": {
                                "Parse_JSON_-_File": [
                                    "Succeeded",
                                    "TimedOut",
                                    "Skipped",
                                    "Failed"
                                ]
                            },
                            "type": "Foreach"
                        },
                        "Initialize_and_Set_default_Azure_Parameters": {
                            "runAfter": {
                                "Initialize_Main_workflow_variables": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "Tenant ID",
                                        "type": "string",
                                        "value": "@{parameters('Azure Tenant ID')}"
                                    },
                                    {
                                        "name": "Client ID",
                                        "type": "string",
                                        "value": "@{parameters('Azure Client ID')}"
                                    },
                                    {
                                        "name": "Subscription ID",
                                        "type": "string",
                                        "value": "@{triggerBody()?['workspaceInfo']?['SubscriptionId']}"
                                    },
                                    {
                                        "name": "Resource Group Name",
                                        "type": "string",
                                        "value": "@{triggerBody()?['workspaceInfo']?['ResourceGroupName']}"
                                    },
                                    {
                                        "name": "Workspace Name",
                                        "type": "string",
                                        "value": "@{triggerBody()?['workspaceInfo']?['WorkspaceName']}"
                                    },
                                    {
                                        "name": "Storage Account Name",
                                        "type": "string",
                                        "value": "@{parameters('Azure Blob Storage Account Name')}"
                                    },
                                    {
                                        "name": "Container Name",
                                        "type": "string",
                                        "value": "@{parameters('Azure Blob Storage Container Name')}"
                                    },
                                    {
                                        "name": "Log Analytics Workspace Name",
                                        "type": "string",
                                        "value": "@{parameters('Log Analytics Workspace')}"
                                    }
                                ]
                            }
                        },
                        "Initialize_Additional_Service_Parameters": {
                            "runAfter": {
                                "Initialize_and_Set_default_Azure_Parameters": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "Connector Version",
                                        "type": "string",
                                        "value": "1.0.0"
                                    },
                                    {
                                        "name": "Array for Response",
                                        "type": "array"
                                    },
                                    {
                                        "name": "Error Handeling",
                                        "type": "boolean",
                                        "value": false
                                    }
                                ]
                            }
                        },
                        "Initialize_Main_workflow_variables": {
                            "runAfter": {
                                "Get_secret_-_ANYRUN": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "Array of Hosts",
                                        "type": "array"
                                    },
                                    {
                                        "name": "Array Of File Paths",
                                        "type": "array"
                                    },
                                    {
                                        "name": "Suspicious File - FilePath",
                                        "type": "string"
                                    },
                                    {
                                        "name": "Suspicious File - FileName",
                                        "type": "string"
                                    },
                                    {
                                        "name": "Script Name",
                                        "type": "string"
                                    },
                                    {
                                        "name": "Script Parameters",
                                        "type": "string"
                                    },
                                    {
                                        "name": "UUID",
                                        "type": "string"
                                    }
                                ]
                            }
                        },
                        "Filter_array_Host": {
                            "runAfter": {
                                "Initialize_Additional_Service_Parameters": [
                                    "Succeeded"
                                ]
                            },
                            "type": "Query",
                            "inputs": {
                                "from": "@body('Entities_-_Get_Hosts')?['Hosts']",
                                "where": "@or(equals(item()?['OSFamily'], 'Windows'), equals(item()?['OSFamily'], 'Linux'), equals(item()?['OSFamily'], 'Ubuntu'), equals(item()?['OSFamily'], 'Debian'), equals(item()?['OSFamily'], 'Unknown'))"
                            }
                        },
                        "Filter_array_unsupported_OS_Host": {
                            "runAfter": {
                                "Initialize_Additional_Service_Parameters": [
                                    "Succeeded"
                                ]
                            },
                            "type": "Query",
                            "inputs": {
                                "from": "@body('Entities_-_Get_Hosts')?['Hosts']",
                                "where": "@not(or(equals(item()?['OSFamily'], 'Windows'), equals(item()?['OSFamily'], 'Linux'), equals(item()?['OSFamily'], 'Ubuntu'), equals(item()?['OSFamily'], 'Debian'), equals(item()?['OSFamily'], 'Unknown')))"
                            }
                        },
                        "Select_-_unsupported_hosts": {
                            "runAfter": {
                                "Filter_array_unsupported_OS_Host": [
                                    "Succeeded"
                                ]
                            },
                            "type": "Select",
                            "inputs": {
                                "from": "@body('Filter_array_unsupported_OS_Host')",
                                "select": "@item()?['HostName']"
                            }
                        },
                        "Condition_-_Is_unsupported_hosts_exists": {
                            "actions": {},
                            "runAfter": {
                                "Select_-_unsupported_hosts": [
                                    "Succeeded"
                                ]
                            },
                            "else": {
                                "actions": {
                                    "Add_comment_to_incident_-_OS_versions_unsupported": {
                                        "type": "ApiConnection",
                                        "inputs": {
                                            "host": {
                                                "connection": {
                                                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                                }
                                            },
                                            "method": "post",
                                            "body": {
                                                "incidentArmId": "@triggerBody()?['object']?['id']",
                                                "message": "<p class=\"editor-paragraph\"><b><strong class=\"editor-text-bold\">The OS of the following hosts is not supported by the workflow: </strong></b>@{body('Select_-_unsupported_hosts')}</p><p class=\"editor-paragraph\"><br>If a file contained in the incident's Entities is located at one of the hosts from this list, it will not be sent for analysis to ANY.RUN Sandbox.</p>"
                                            },
                                            "path": "/Incidents/Comment"
                                        }
                                    }
                                }
                            },
                            "expression": {
                                "and": [
                                    {
                                        "equals": [
                                            "@empty(body('Select_-_unsupported_hosts'))",
                                            true
                                        ]
                                    }
                                ]
                            },
                            "type": "If"
                        }
                    },
                    "outputs": {}
                },
                "parameters": {
                    "$connections": {
                        "value": {
                            "azuresentinel": {
                                "connectionId": "[resourceId('Microsoft.Web/connections', variables('azuresentinelConnectionName'))]",
                                "connectionName": "[variables('azuresentinelConnectionName')]",
                                "id": "[variables('azuresentinelApiId')]"
                            },
                            "azureblob": {
                                "connectionId": "[resourceId('Microsoft.Web/connections', variables('azureblobConnectionName'))]",
                                "connectionName": "[variables('azureblobConnectionName')]",
                                "id": "[variables('azureblobApiId')]"
                            },
                            "keyvault": {
                                "connectionId": "[resourceId('Microsoft.Web/connections', variables('keyVaultConnectionName'))]",
                                "connectionName": "[variables('keyVaultConnectionName')]",
                                "id": "[variables('keyVaultApiId')]"
                            },
                            "azuremonitorlogs": {
                                "connectionId": "[resourceId('Microsoft.Web/connections', variables('azuremonitorlogsConnectionName'))]",
                                "connectionName": "[variables('azuremonitorlogsConnectionName')]",
                                "id": "[variables('azuremonitorlogsApiId')]"
                            },
                            "wdatp": {
                                "connectionId": "[resourceId('Microsoft.Web/connections', variables('wdatpConnectionName'))]",
                                "connectionName": "[variables('wdatpConnectionName')]",
                                "id": "[variables('wdatpApiId')]"
                            }
                        }
                    }
                }
            },
            "dependsOn": [
                "[resourceId('Microsoft.Web/connections', variables('azuresentinelConnectionName'))]",
                "[resourceId('Microsoft.Web/connections', variables('azureblobConnectionName'))]",
                "[resourceId('Microsoft.Web/connections', variables('keyVaultConnectionName'))]",
                "[resourceId('Microsoft.Web/connections', variables('azuremonitorlogsConnectionName'))]",
                "[resourceId('Microsoft.Web/connections', variables('wdatpConnectionName'))]"
            ]
        }
    ]
}
